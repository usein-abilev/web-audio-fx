(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))r(c);new MutationObserver(c=>{for(const s of c)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function o(c){const s={};return c.integrity&&(s.integrity=c.integrity),c.referrerPolicy&&(s.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?s.credentials="include":c.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(c){if(c.ep)return;c.ep=!0;const s=o(c);fetch(c.href,s)}})();const Z=["audio/mpeg","audio/ogg","audio/wave","audio/wav","audio/x-wav","audio/mp4","audio/flac"],Q=8*1024*1024,se=i=>i?Z.includes(i.type)?i.size>Q?{ok:!1,message:"File size has exceeded the MAX_AUDIO_FILE_SIZE constraint: "+Q}:{ok:!0}:{ok:!1,message:"Unsupported file type. Supported MIME-types: "+Z}:{ok:!1,message:"File not found"},ae={BASE_URL:"/web-audio-fx/"},ne=i=>20*Math.log10(i),re=i=>10**(i/20),ce=(i,e,o)=>e+(o-e)*i,le=(i,e,o)=>e+(o-e)*i**2.5,de=(i,e,o)=>e*(o/e)**i,J=(i,e,o,r)=>Math.sqrt((o-i)**2+(r-e)**2),ue=i=>{const{BASE_URL:e}=ae,o=e.endsWith("/")?e:e+"/",r=i.startsWith("/")?i.substring(1):i;return o+r},pe=i=>{const e=Math.floor(i/60),o=Math.floor(i%60);return`${e.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`},U=()=>{const i=Date.now().toString(16),e=Math.floor(Math.random()*2**52).toString(16);return`${i}-${e}`},fe=async i=>{try{return await(await fetch(i)).arrayBuffer()}catch(e){throw console.error("Error fetching audio array buffer:",e),new Error("Error fetching audio data")}},F=(i,e)=>{try{return i.disconnect(e),!0}catch{return!1}},he=80,G=1024*4,me=i=>Math.sqrt(i.reduce((e,o)=>e+o*o,0)/i.length),ge=i=>{const e=document.getElementById("audio-volume-meter"),o=e.getContext("2d"),r=i.createAnalyser();r.fftSize=G;const c=i.createAnalyser();c.fftSize=G;const s=new Float32Array(G),l=new Float32Array(G),n=60,d=2,g=(x,E)=>{const A=me(x),O=ne(A),a=-20,p=-6,h=(Math.min(a,O)+n)/n,m=(Math.min(p,O)+n)/n,y=(Math.min(0,O)+n)/n,I=e.height-h*e.height,C=e.height-m*e.height,M=e.height-y*e.height,P=e.width/2+d*(E*2-1);o.fillStyle="#ff0000",o.fillRect(E*P,M,e.width/2,e.height),o.fillStyle="#ffbb4a",o.fillRect(E*P,C,e.width/2,e.height),o.fillStyle="#50bb4a",o.fillRect(E*P,I,e.width/2,e.height)},N=()=>{requestAnimationFrame(N),r.getFloatTimeDomainData(s),c.getFloatTimeDomainData(l),o.clearRect(0,0,e.width,e.height),g(s,0),g(l,1);const x=e.height/(n/5);for(let E=0;E<=n/5;E++){const A=E*x;o.fillStyle="#fefefe",o.font="9px Consolas",o.fillText(`${E*5}`,1,A-2),o.fillStyle="#888",o.fillRect(0,A,10,1)}};return N(),{connect(x){const E=i.createChannelSplitter(2);E.connect(r,0),E.connect(c,1),x.connect(E)},resize(x,E){e.width=x,e.height=E},getWidth:()=>he}},w={createContainer(...i){const e=document.createElement("div");return e.className="plugin-container",i.forEach(o=>e.appendChild(o)),e},block(i){const e=document.createElement("div");return e.className="flex-block",e.append(...i),e},splitterHorizontal(){const i=document.createElement("div");return i.className="horizontal-splitter",i},slider(i,e,o={defaultValue:0,value:0}){const r=document.createElement("div"),c=document.createElement("input"),s=document.createElement("label"),l=document.createElement("label"),n=o.value??o.defaultValue??0;return typeof o.formatter=="function"?l.append(o.formatter(n)):l.innerText=n.toFixed(1),r.className="band",c.type="range",c.value=String(n),console.log("Set input value for '%s'",i,c.value,o.value),s.append(i),r.append(c,l,s),Object.assign(c,o),c.addEventListener("input",d=>{const g=+d.target.value;e(g,d),l.innerHTML="",typeof o.formatter=="function"?l.append(o.formatter(g)):l.innerText=g.toFixed(1)}),r.addEventListener("dblclick",()=>{c.value=String(o.defaultValue??0),c.dispatchEvent(new Event("input"))}),r},select(i,e,o){const r=document.createElement("div");r.className="select-block";const c=document.createElement("span"),s=document.createElement("select");s.name="plugin-select",s.value=o.selectedValue||"";const l=o.options.map(({value:n,displayText:d})=>{const g=document.createElement("option");return g.value=n,g.innerText=d,o.selectedValue===n&&g.setAttribute("selected","true"),g});return s.addEventListener("change",n=>{e(n.target.value,n)}),c.append(i),s.append(...l),r.append(c,s),r},checkbox(i,e,o){const r=document.createElement("label"),c=document.createElement("input");return c.type="checkbox",c.checked=!!o.defaultValue,c.addEventListener("change",s=>{e(s.target.checked,s)}),r.append(i,c),r},knob(i,e,o){const r=document.createElement("div");r.className="knob-container";const c=document.createElement("div");c.className="label",c.append(i);const s=document.createElement("div"),l=document.createElement("div"),n=document.createElement("div");s.className="knob",l.className="arc",n.className="indicator",s.append(l,n);const d=document.createElement("div");d.className="value";const g=(o.max??1)*100;let N=o.value*100,x=!1,E=0;const A=()=>{const a=N*270/g-135;l.style.setProperty("--angle",`${270/g*N}deg`),n.style.transform=`translateX(-50%) rotate(${a}deg)`,d.textContent=o.formatter?.(N/100)||String(N)},O=(a,p)=>{N=a,N=Math.max(o.min||0,Math.min(g,N)),e(N/100,p),A()};return s.addEventListener("mousedown",a=>{x=!0,E=a.clientY}),s.addEventListener("dblclick",a=>{O(o.defaultValue*100,a)}),s.addEventListener("wheel",a=>{const p=-1*Math.sign(a.deltaY);N+=p*2,O(N,a)}),document.addEventListener("mouseup",()=>x=!1),document.addEventListener("mousemove",a=>{if(!x)return;const p=E-a.clientY;E=a.clientY,N+=p*(o.speed||.5),O(N,a)}),A(),r.append(c,s,d),r}};class W{constructor(e){this.audioContext=e,this.input=this.audioContext.createGain(),this.output=this.audioContext.createGain();const o=re(0),r={min:0,max:2,defaultValue:o,value:o,speed:.3,formatter:s=>`${ne(s).toFixed(1)} dB`},c=(s,l)=>{s.gain.setValueAtTime(l,this.audioContext.currentTime)};this.inputSlider=w.knob("Input Gain",s=>c(this.input,s),r),this.outputSlider=w.knob("Output Gain",s=>c(this.output,s),r)}input;output;inputSlider;outputSlider;get name(){return"Audio Graph Node"}get[Symbol.toStringTag](){return"AudioGraphNode"}}class V extends W{bypass=!1;dryNode;wetNode;mixValue=1;mixSliderElement;constructor(e){super(e),this.dryNode=this.audioContext.createGain(),this.wetNode=this.audioContext.createGain(),this.setMixValue(1),this.setBypass(!1),this.mixSliderElement=w.knob("Mix",o=>this.setMixValue(o),{max:1,value:this.getMixValue(),defaultValue:1})}setBypass(e){this.bypass=e,this.bypass?(F(this.wetNode,this.output),F(this.dryNode,this.output),F(this.input,this.dryNode),this.input.connect(this.output)):(F(this.input,this.output),this.input.connect(this.dryNode),this.dryNode.connect(this.output),this.wetNode.connect(this.output))}getMixValue(){return this.mixValue}setMixValue(e){this.mixValue=e,this.dryNode.gain.value=1-this.mixValue,this.wetNode.gain.value=this.mixValue}render(e){e.innerHTML=""}get name(){return"Unknown Audio Plugin"}get[Symbol.toStringTag](){return"Audio Plugin"}}class ye extends W{mono=!1;channelMerger;stereoPanner;panKnob;get name(){return"Input Node"}constructor(e){super(e),this.channelMerger=e.createChannelMerger(),this.stereoPanner=e.createStereoPanner(),this.input.connect(this.stereoPanner),this.stereoPanner.connect(this.output),this.panKnob=w.knob("Pan",o=>{this.stereoPanner.pan.setValueAtTime(o*2-1,this.audioContext.currentTime),console.log("stereo panner:",this.stereoPanner.pan.value,o)},{max:1,defaultValue:.5,value:(this.stereoPanner.pan.value+1)/2,formatter:o=>{let r="C";return o<.5?r="L":o>.5&&(r="R"),`${Math.abs(o*200-100).toFixed(0)} ${r}`}})}setMono(e){this.mono=e,e?(this.input.disconnect(this.stereoPanner),this.input.connect(this.channelMerger,0,0),this.input.connect(this.channelMerger,0,1),this.channelMerger.connect(this.stereoPanner)):(this.input.disconnect(this.channelMerger),this.channelMerger.disconnect(),this.input.connect(this.stereoPanner))}render(e){e.innerHTML="";const o=w.createContainer(w.checkbox("Mono: ",r=>this.setMono(r),{defaultValue:this.mono}),this.panKnob,this.inputSlider,this.outputSlider);e.append(o)}}class be extends W{constructor(e){super(e),this.input.connect(this.output)}get name(){return"Output Node"}render(e){e.innerHTML="";const o=w.createContainer(this.inputSlider,this.outputSlider);e.append(o)}}const Ne=(i,e,o)=>{const r=document.getElementById("context-menu"),c=document.createElement("ul");r.innerHTML="",r.append(c),i.addEventListener("mousedown",()=>{r.style.display="none"}),i.addEventListener("contextmenu",s=>{s.preventDefault();const{clientX:l,clientY:n}=s;if(!e(s))return;const d=o.map(g=>{if(!g.canShow?.())return;const N=document.createElement("li");return N.dataset.action=g.key,N.innerText=typeof g.displayText=="string"?g.displayText:g.displayText(),N.addEventListener("click",x=>{x.preventDefault(),g.handler(x),r.style.display="none"}),N}).filter((g=>g));d.length&&(c.innerHTML="",c.append(...d),r.style.display="block",r.style.left=`${l}px`,r.style.top=`${n}px`)})},v={NODE_WIDTH:150,NODE_HEIGHT:50,CONNECTOR_GAP:15,CONNECTOR_RADIUS:5,CONNNECTOR_RADIUS_HOVERED:10},Ee=i=>{const e={nodes:[{type:"input",id:U(),instance:new ye(i.audioContext),position:{x:0,y:0},connections:{}},{type:"output",id:U(),instance:new be(i.audioContext),position:{x:0,y:0},connections:{}}]},[o,r]=e.nodes,c=(a,p)=>{if(console.log("Creating new connection between",a,p),a.connections[p.id])return a.instance.output.disconnect(p.instance.input),delete a.connections[p.id],i.onUpdate(e),!0;const h=[p.id],m=new Set;for(;h.length;){const y=h.pop();if(y){if(y===a.id)return console.warn("The connection between nodes (%s -> %s) will cause a circular dependency",a.id,p.id),!1;if(!m.has(y)){m.add(y);const I=e.nodes.find(C=>C.id===y);h.push(...Object.keys(I.connections));continue}}}return a.connections[p.id]=1,a.instance.output.connect(p.instance.input),i.onUpdate(e),!0};c(o,r);const s={isConnector:!1,isInput:!1,nodeId:""},l=document.getElementById("audio-plugin"),n=document.getElementById("graph"),d=n.getContext("2d");Ne(n,()=>!!e.selectedNode,[{key:"bypass",displayText:()=>e.selectedNode?.type==="plugin"?e.selectedNode.instance.bypass?"Activate node":"Bypass node":"",canShow:()=>e.selectedNode?.type==="plugin",handler:()=>{if(!e.selectedNode)return;const a=e.selectedNode.instance;a.setBypass(!a.bypass)}},{key:"delete",displayText:"Delete node",canShow:()=>e.selectedNode?.type==="plugin",handler:()=>{if(!e.selectedNode||e.selectedNode.type!=="plugin")return;console.log("Deleting:",e.selectedNode,e.nodes);const a=new Map;let p=-1;e.nodes.forEach((h,m)=>{if(a.set(h.id,h),h.id===e.selectedNode.id){p=m;return}if(e.selectedNode.id in h.connections){try{h.instance.output.disconnect(e.selectedNode.instance.input)}catch{}delete h.connections[e.selectedNode.id]}});for(const h in e.selectedNode.connections){const m=a.get(h);if(m)try{e.selectedNode.instance.output.disconnect(m.instance.input)}catch{}}delete e.selectedNode,e.nodes.splice(p,1),l.innerHTML=""}}]);const g=()=>{requestAnimationFrame(g),d.clearRect(0,0,n.width,n.height);for(const a of e.nodes){const p=e.selectedNode?.id===a.id;d.save(),d.globalAlpha=a.type==="plugin"&&a.instance.bypass?.5:1,d.beginPath(),d.fillStyle="transparent",d.strokeStyle=p?"steelblue":"#555",d.roundRect(a.position.x,a.position.y,v.NODE_WIDTH,v.NODE_HEIGHT,5),d.closePath(),d.stroke(),d.fill(),d.fillStyle="#FFFFFF",d.font="14px Arial";const h=a.instance.name;d.fillText(h,a.position.x+10,a.position.y+25),d.restore();const m=s.isConnector&&s.nodeId===a.id;if(a.type!=="input"){const y=m&&s.isInput?v.CONNNECTOR_RADIUS_HOVERED:v.CONNECTOR_RADIUS;d.fillStyle="#555555",d.beginPath(),d.arc(a.position.x-v.CONNECTOR_GAP,a.position.y+v.NODE_HEIGHT/2,y,0,Math.PI*2),d.fill()}if(a.type!=="output"){const y=m&&!s.isInput?v.CONNNECTOR_RADIUS_HOVERED:v.CONNECTOR_RADIUS;d.fillStyle="#555555",d.beginPath(),d.arc(a.position.x+v.NODE_WIDTH+v.CONNECTOR_GAP,a.position.y+v.NODE_HEIGHT/2,y,0,Math.PI*2),d.fill()}for(const y in a.connections){const I=e.nodes.find(C=>C.id===y);if(I){const C=a.position.x+v.NODE_WIDTH+v.CONNECTOR_GAP,M=a.position.y+v.NODE_HEIGHT/2,P=I.position.x-v.CONNECTOR_GAP,D=I.position.y+v.NODE_HEIGHT/2,_=C+v.NODE_HEIGHT,u=M,f=P-v.NODE_HEIGHT,b=D;d.strokeStyle="#888888",d.beginPath(),d.moveTo(C,M),d.bezierCurveTo(_,u,f,b,P,D),d.stroke()}}}if(e.linking){const{NODE_WIDTH:a,NODE_HEIGHT:p,CONNECTOR_GAP:h}=v,m=e.nodes.find(C=>C.id===e.linking.nodeSourceId),y=e.linking.isSourceInput?m.position.x-h:m.position.x+a+h,I=m.position.y+p/2;d.strokeStyle="steelblue",d.beginPath(),d.moveTo(y,I),d.lineTo(e.linking.mouseX,e.linking.mouseY),d.stroke()}};g();const N=(a,p)=>{for(const h of e.nodes){const{x:m,y}=h.position;if(m<=a&&m+v.NODE_WIDTH>=a&&y<=p&&y+v.NODE_HEIGHT>=p)return h}return null},x=(a,p)=>{const h=v.CONNNECTOR_RADIUS_HOVERED;for(const m of e.nodes){const{x:y,y:I}=m.position;if(m.type!=="input"&&J(a,p,y-v.CONNECTOR_GAP,I+v.NODE_HEIGHT/2)<=h)return{node:m,input:!0};if(m.type!=="output"&&J(a,p,y+v.NODE_WIDTH+v.CONNECTOR_GAP,I+v.NODE_HEIGHT/2)<=h)return{node:m,input:!1}}return null},E=a=>{a.instance.render(l)},A=a=>{n.style.cursor=a};n.addEventListener("mousedown",a=>{const{offsetX:p,offsetY:h}=a,m=x(p,h);if(m){e.linking={nodeSourceId:m.node.id,isSourceInput:m.input,mouseX:p,mouseY:h},A("grabbing");return}const y=N(p,h);if(y){A("grabbing"),e.selectedNode?.id!==y.id&&E(y),e.selectedNode=y,e.draggingAnchor={x:p-y.position.x,y:h-y.position.y};return}delete e.selectedNode,l.innerHTML=""}),n.addEventListener("mousemove",a=>{const{offsetX:p,offsetY:h}=a,m=x(p,h);if(m)s.nodeId=m.node.id,s.isInput=m.input,s.isConnector=!0,n.style.cursor="pointer";else{s.isConnector=!1;const y=N(p,h);y?(n.style.cursor="pointer",s.nodeId=y.id):(n.style.cursor="default",s.nodeId="")}e.linking&&(e.linking.mouseX=p,e.linking.mouseY=h,A("grabbing")),e.draggingAnchor&&e.selectedNode&&(e.selectedNode.position.x=p-e.draggingAnchor.x,e.selectedNode.position.y=h-e.draggingAnchor.y)}),n.addEventListener("mouseup",a=>{const{offsetX:p,offsetY:h}=a;if(e.draggingAnchor&&e.selectedNode&&(A("default"),delete e.draggingAnchor),e.linking){const m=x(p,h),y=e.nodes.find(C=>C.id===e.linking.nodeSourceId),{isSourceInput:I}=e.linking;m&&y&&m.input!==e.linking.isSourceInput&&(I?c(m.node,y):c(y,m.node)),delete e.linking}});const O=()=>{n.width=document.body.clientWidth-20,n.height=350,o.position.x=50,o.position.y=n.height/2,r.position.x=n.width-200,r.position.y=n.height/2};return O(),window.addEventListener("resize",O),{apply(a,p){r.instance.output.disconnect(),r.instance.output.connect(p),a.connect(o.instance.input)},analyze(a){a(r.instance.output)},addPlugin(a){const p={id:U(),type:"plugin",position:{x:n.width/2,y:n.height/2},instance:a,connections:{}};return e.nodes.push(p),!0}}};class $ extends V{static NAME="Equalizer (7 Band)";get name(){return $.NAME}bands;blockElement;constructor(e){super(e),this.bands=[80,250,500,1500,3e3,5e3,8e3].map((r,c)=>{const s=this.audioContext.createBiquadFilter();return c===0?s.type="lowshelf":c===6?s.type="highshelf":s.type="peaking",s.frequency.value=r,s.Q.value=1,s}),this.bands.reduce((r,c)=>(r.connect(c),c)),this.input.connect(this.bands[0]),this.bands.at(-1)?.connect(this.wetNode);const o={min:-12,max:12,step:.1,defaultValue:0};this.blockElement=w.block(this.bands.map(r=>w.slider(`${r.frequency.value}Hz`,c=>r.gain.setValueAtTime(c,this.audioContext.currentTime+.01),{...o,formatter:c=>`${c.toFixed(1)} dB`,value:r.gain.value})))}render(e){const o=w.createContainer(this.blockElement,this.mixSliderElement,this.inputSlider,this.outputSlider);e.innerHTML="",e.appendChild(o)}}const ee=[{title:"Church",path:"/impulse_responses/Church Schellingwoude/Church Schellingwoude.wav"},{title:"Factory Hall",path:"/impulse_responses/Factory Hall/Factory Hall/Factory Hall.wav"},{title:"Claustrofobia v1.1",path:"/impulse_responses/Claustrofobia v1.1/Dustbin 3 mono/Dustbin 3.C.wav"}].map(i=>({...i,path:ue(i.path)}));class q extends V{static NAME="Reverb (IR)";get name(){return q.NAME}convolver;selectedIRPath="";constructor(e){super(e),this.convolver=this.audioContext.createConvolver(),this.input.connect(this.convolver).connect(this.wetNode)}setIRBuffer(e){this.convolver.buffer=e}render(e){const o=ee.map(s=>({value:s.path,displayText:s.title})),r=s=>{this.selectedIRPath!==s&&(this.selectedIRPath=s,console.log("(reverb): Loading IR from path:",s),fe(s).then(l=>this.audioContext.decodeAudioData(l)).then(l=>this.setIRBuffer(l)).catch(l=>console.error("Error fetching IR audio buffer:",l)))};this.selectedIRPath||r(ee[0].path);const c=w.createContainer(w.select("Type",r,{options:o,selectedValue:this.selectedIRPath}),this.mixSliderElement);e.innerHTML="",e.appendChild(c)}}class K extends V{static NAME="Delay";get name(){return K.NAME}maxDelayTime=5;delay;feedback;constructor(e){super(e),this.delay=e.createDelay(this.maxDelayTime),this.feedback=e.createGain(),this.delay.delayTime.value=.5,this.feedback.gain.value=.2,this.delay.connect(this.feedback),this.feedback.connect(this.delay),this.input.connect(this.delay),this.delay.connect(this.wetNode)}render(e){const o=w.createContainer(w.slider("Feedback",r=>this.feedback.gain.value=r,{min:0,max:2,value:this.feedback.gain.value,defaultValue:.2,step:.01,formatter:r=>`${(r*100).toFixed(0)}%`}),w.slider("Delay",r=>this.delay.delayTime.value=r,{min:0,max:this.maxDelayTime,value:this.delay.delayTime.value,defaultValue:.5,step:.1,formatter:r=>`${r.toFixed(1)} sec`}),this.mixSliderElement,this.inputSlider,this.outputSlider);e.innerHTML="",e.appendChild(o)}}class xe extends V{get name(){return"Compressor"}compressor;blockElement;constructor(e){super(e),this.compressor=e.createDynamicsCompressor(),this.input.connect(this.compressor),this.compressor.connect(this.wetNode);const o=n=>`${n.toFixed(1)} dB`,r=n=>`${(n*1e3).toFixed(1)} ms`,s={threshold:{min:-60,max:0,defaultValue:0,format:o,type:"log"},knee:{min:0,max:40,defaultValue:18,format:o,type:"log"},ratio:{min:1,max:20,defaultValue:4,format:n=>n.toFixed(1),type:"linear"},attack:{min:.005,max:.25,defaultValue:.005,speed:.2,format:r,type:"exp"},release:{min:.005,max:.25,defaultValue:.005,speed:.2,format:r,type:"exp"}},l=n=>{let d=ce;return n==="log"?d=le:n==="exp"&&(d=de),d};this.blockElement=w.block(Object.keys(s).map(n=>{const d=n,g=s[d],N=this.compressor[d],x=l(g.type);return w.knob(d.charAt(0).toUpperCase()+d.slice(1),E=>N.setValueAtTime(x(E,g.min,g.max),this.audioContext.currentTime),{defaultValue:.5,value:.5,speed:"speed"in g?g.speed:.5,formatter:E=>g.format?.(x(E,g.min,g.max))})}))}render(e){const o=w.createContainer(w.splitterHorizontal(),this.blockElement,w.splitterHorizontal(),this.mixSliderElement,this.inputSlider,this.outputSlider);e.innerHTML="",e.appendChild(o)}}const oe=44100,Se={sampleRate:oe},t={recording:!1,playback:null,playbackOffsetSeconds:0,selection:{selected:!1,selecting:!1,start:0,end:0},audioContext:new AudioContext(Se),rawAudioBuffer:null,sourceNode:null,currentFile:null},Y={PLAY:"Space"},te=[{id:"reverb",name:"Reverb",getInstance:i=>new q(i)},{id:"equalizer",name:"EQ (7 Band)",getInstance:i=>new $(i)},{id:"delay",name:"Delay",getInstance:i=>new K(i)},{id:"compressor",name:"Compressor",getInstance:i=>new xe(i)}],ve=()=>(t.playback?t.audioContext.currentTime-t.playback.startedTime:0)+t.playbackOffsetSeconds;window.addEventListener("load",async()=>{const i=document.getElementById("load-sample"),e=document.getElementById("sample-file-input"),o=document.getElementById("loop-playback"),r=document.getElementById("record"),c=document.getElementById("play"),s=document.getElementById("add-plugin-select"),l=document.querySelector("canvas"),n=l.getContext("2d"),d=ge(t.audioContext),g=Ee({audioContext:t.audioContext,onUpdate:u=>console.log("Audio Graph Updated!",u)});(()=>{for(const u of te){const f=document.createElement("option");f.value=u.id,f.innerText=u.name,s.add(f)}s.addEventListener("change",u=>{const f=te.find(b=>b.id===u.target?.value);f&&(console.log("Adding plugin:",f),g.addPlugin(f.getInstance(t.audioContext)),s.value="")})})();let N=0,x=0,E=1,A=null;const O=u=>{if(!t.rawAudioBuffer)return 0;const b=(u-x)/(l.width*E)*t.rawAudioBuffer.length;return Math.round(b)},a=()=>{c.innerText=(t.playback?"Pause":"Play")+` (${Y.PLAY})`},p=u=>{if(!t.sourceNode)return 0;let f=t.playbackOffsetSeconds+u;if(t.sourceNode.loop)if(t.selection.selected){const b=t.sourceNode.loopEnd-t.sourceNode.loopStart,S=(f-t.sourceNode.loopStart)%b+b%b;f=t.sourceNode.loopStart+S}else f%=t.rawAudioBuffer.duration;return Math.max(0,f)},h=()=>{if(!t.playback)return!1;if(t.sourceNode){const u=t.audioContext.currentTime-t.playback.startedTime;t.playbackOffsetSeconds=p(u),t.sourceNode.onended=null,t.sourceNode.stop(),t.sourceNode.disconnect(),t.sourceNode=null,console.log("Pause! Played seconds: (%f sec, offset = %f sec)",u,t.playbackOffsetSeconds,t.rawAudioBuffer.duration)}t.playback=null,a()},m=()=>{if(t.playback)return;if(!t.rawAudioBuffer){console.log("Cannot play audio without audio buffer",t);return}const{length:u,duration:f}=t.rawAudioBuffer,b=t.selection.start/u*f,S=t.selection.end/u*f;t.sourceNode=t.audioContext.createBufferSource(),t.sourceNode.buffer=t.rawAudioBuffer,t.sourceNode.loop=o.checked,t.sourceNode.playbackRate.value=1,t.sourceNode.loopStart=Math.min(b,S),t.sourceNode.loopEnd=Math.max(b,S),g.apply(t.sourceNode,t.audioContext.destination),g.analyze(d.connect),t.sourceNode.onended=k=>{t.playback&&(console.log("Playback ended event",{event:k,state:t}),t.playback=null,t.playbackOffsetSeconds=t.selection.selected?Math.min(b,S):0,t.sourceNode?.stop(),t.sourceNode?.disconnect(),t.sourceNode=null,a())};let T=0;if(t.selection.selected){const k=t.sourceNode.loop?t.sourceNode.loopStart:t.playbackOffsetSeconds;T=Math.max(0,t.sourceNode.loopEnd-k)}t.sourceNode.start(0,t.playbackOffsetSeconds,t.selection.selected&&!t.sourceNode.loop?T:void 0),t.playback={startedTime:t.audioContext.currentTime},a()},y=u=>{h(),E=1,x=0,N=0,t.rawAudioBuffer=u,A=null},I=()=>{const u=document.createElement("canvas");u.width=l.width,u.height=l.height;const f=u.getContext("2d");if(!t.rawAudioBuffer)return u;const b=t.rawAudioBuffer.getChannelData(0),S=l.width*E,T=b.length,k=Math.ceil(T/S);f.beginPath();const B=l.height/2;for(let R=0;R<l.width;R++){const j=Math.floor((R-x)/S*T),ie=Math.min(T,j+k);let z=1,X=-1;for(let L=j;L<ie&&L<b.length;L++){const H=b[L];H>X&&(X=H),H<z&&(z=H)}f.moveTo(R,(1+z)*B),f.lineTo(R,(1+X)*B)}return f.closePath(),f.strokeStyle="rgba(126, 36, 128, 1)",f.stroke(),u};let C=0;const M=u=>{if(!C)return C=u,requestAnimationFrame(M);const f=(u-C)/1e3;if(C=u,!t.rawAudioBuffer)return requestAnimationFrame(M);const b=t.rawAudioBuffer;n.clearRect(0,0,l.width,l.height),A??=I(),n.drawImage(A,0,0);const S=l.width*E;if(n.beginPath(),n.moveTo(N,0),n.lineTo(N,l.height),n.closePath(),n.strokeStyle="#6d6d6d44",n.stroke(),t.selection.selecting||t.selection.selected){const T=t.selection.start/b.length*S+x,k=t.selection.end/b.length*S+x;n.fillStyle="rgba(67, 140, 235, 0.5)",n.fillRect(T,0,k-T,l.height),n.beginPath(),n.moveTo(T,0),n.lineTo(T,l.height),n.closePath(),n.lineWidth=2,n.strokeStyle="rgba(67, 140, 235, 1)",n.stroke(),n.beginPath(),n.moveTo(k,0),n.lineTo(k,l.height),n.closePath(),n.lineWidth=2,n.strokeStyle="rgba(67, 140, 235, 1)",n.stroke()}if(t.playback&&t.sourceNode){const T=t.audioContext.currentTime-t.playback.startedTime,B=p(T)*S/t.rawAudioBuffer.duration+x;n.beginPath(),n.moveTo(B,0),n.lineTo(B,l.height),n.closePath(),n.strokeStyle="#ffffffff",n.lineWidth=2,n.stroke()}else if(t.playbackOffsetSeconds>0){const T=t.playbackOffsetSeconds*S/t.rawAudioBuffer.duration+x;n.beginPath(),n.moveTo(T,0),n.lineTo(T,l.height),n.closePath(),n.strokeStyle="#ffffffff",n.lineWidth=2,n.stroke()}if(n.font="14px Monospace",n.fillStyle="rgba(46, 204, 6, 1)",n.fillText("FPS: "+(1/f).toFixed(0),14,24),t.currentFile){const T=`File: ${t.currentFile.name} | ${(t.currentFile.size/1024/1024).toFixed(2)} MB`,k=n.measureText(T);n.fillStyle="rgba(255, 255, 255, 1)",n.fillText(T,l.width-k.width-10,24)}n.save(),n.fillStyle="#fff",n.textAlign="center",n.textBaseline="middle",n.fillText(pe(ve()),l.width/2,24),n.restore(),requestAnimationFrame(M)};requestAnimationFrame(M);const P=()=>{const u={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,channelCount:1,sampleRate:oe}};let f=null;return async()=>{if(t.recording)f&&(f.stop(),f=null),t.recording=!1;else{const b=await navigator.mediaDevices.getUserMedia(u).catch(console.error);if(!b)return;let S=[];f=new MediaRecorder(b,{mimeType:"audio/webm"}),f.ondataavailable=T=>{console.log("New recorded data of size:",T.data.size),S.push(T.data)},f.onstop=()=>{const T=new Blob(S,{type:"audio/webm"});S=[],T.arrayBuffer().then(k=>t.audioContext.decodeAudioData(k)).then(k=>y(k)).then(()=>t.currentFile=null).catch(k=>console.error("Unable to get an array buffer from MediaRecorder:",k))},f.start(),t.recording=!0}r.innerText=t.recording?"Stop":"Record"}};r.onclick=P(),i.addEventListener("click",()=>e.click()),e.addEventListener("change",()=>{const[u]=e.files||[];if(!u)return;const f=se(u);if(!f.ok){console.error(f.message,u);return}const b=new FileReader;b.onload=()=>{b.result instanceof ArrayBuffer&&t.audioContext.decodeAudioData(b.result).then(y).then(()=>t.currentFile=u).catch(S=>console.error("Error during decoding an audio file:",S))},b.onerror=S=>{console.error("File reading error",S)},b.onprogress=S=>{console.log("File reading progress:",S)},b.readAsArrayBuffer(u)});const D=()=>{t.playback?h():m(),c.innerText=(t.playback?"Pause":"Play")+` (${Y.PLAY})`};c.addEventListener("click",D),window.addEventListener("keydown",u=>{if(u.code===Y.PLAY)return u.preventDefault(),D()}),l.addEventListener("mousemove",u=>{N=u.offsetX,t.rawAudioBuffer&&t.selection.selecting&&(t.selection.end=O(u.offsetX))}),l.addEventListener("mousedown",u=>{if(t.rawAudioBuffer){t.selection.selecting=!0;const f=O(u.offsetX);t.selection.start=f,t.selection.end=f}}),window.addEventListener("mouseup",u=>{const b=u.target&&u.target instanceof HTMLCanvasElement?u.offsetX:N;if(t.rawAudioBuffer&&t.selection.selecting){t.selection.end=O(b),t.selection.selecting=!1,t.selection.selected=t.selection.start!==t.selection.end,console.log("Selection event on mouseup:",t.selection);const S=Math.max(0,Math.min(t.selection.start,t.selection.end)/t.rawAudioBuffer.length*t.rawAudioBuffer.duration);t.playback?(h(),t.playbackOffsetSeconds=S,m()):t.playbackOffsetSeconds=S}}),l.addEventListener("wheel",u=>{if(u.preventDefault(),!t.rawAudioBuffer)return!1;const f=u.ctrlKey?.5:.1,b=1-Math.sign(u.deltaY)*f,S=Math.max(1,E*b),T=l.width*S-l.width,k=(N-x)/(l.width*E);x=Math.max(-T,Math.min(0,N-k*l.width*S)),A=null,E=S});const _=()=>{const u=d.getWidth();d.resize(u,200),l.width=document.body.clientWidth-u-30,l.height=200,A=null};window.addEventListener("resize",_),_()});
