(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))c(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const s of l.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&c(s)}).observe(document,{childList:!0,subtree:!0});function o(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function c(i){if(i.ep)return;i.ep=!0;const l=o(i);fetch(i.href,l)}})();const j=["audio/mpeg","audio/ogg","audio/wave","audio/wav","audio/x-wav","audio/mp4","audio/flac"],Z=8*1024*1024,ie=r=>r?j.includes(r.type)?r.size>Z?{ok:!1,message:"File size has exceeded the MAX_AUDIO_FILE_SIZE constraint: "+Z}:{ok:!0}:{ok:!1,message:"Unsupported file type. Supported MIME-types: "+j}:{ok:!1,message:"File not found"},se={BASE_URL:"/web-audio-fx/"},te=r=>20*Math.log10(r),re=r=>10**(r/20),ae=(r,e,o)=>e+(o-e)*r,ce=(r,e,o)=>e+(o-e)*r**2.5,le=(r,e,o)=>e*(o/e)**r,de=r=>{const{BASE_URL:e}=se,o=e.endsWith("/")?e:e+"/",c=r.startsWith("/")?r.substring(1):r;return o+c},ue=r=>{const e=Math.floor(r/60),o=Math.floor(r%60);return`${e.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`},U=()=>{const r=Date.now().toString(16),e=Math.floor(Math.random()*2**52).toString(16);return`${r}-${e}`},Q=(r,e,o,c)=>Math.sqrt((o-r)**2+(c-e)**2),fe=async r=>{try{return await(await fetch(r)).arrayBuffer()}catch(e){throw console.error("Error fetching audio array buffer:",e),new Error("Error fetching audio data")}},P=()=>({createContainer(...r){const e=document.createElement("div");return e.className="plugin-container",r.forEach(o=>e.appendChild(o)),e},block(r){const e=document.createElement("div");return e.className="flex-block",e.append(...r),e},splitterHorizontal(){const r=document.createElement("div");return r.className="horizontal-splitter",r},slider(r,e,o={defaultValue:0,value:0}){const c=document.createElement("div"),i=document.createElement("input"),l=document.createElement("label"),s=document.createElement("label"),n=o.value??o.defaultValue??0;return typeof o.formatter=="function"?s.append(o.formatter(n)):s.innerText=n.toFixed(1),c.className="band",i.type="range",i.value=String(n),console.log("Set input value for '%s'",r,i.value,o.value),l.append(r),c.append(i,s,l),Object.assign(i,o),i.addEventListener("input",N=>{const y=+N.target.value;e(y,N),s.innerHTML="",typeof o.formatter=="function"?s.append(o.formatter(y)):s.innerText=y.toFixed(1)}),c.addEventListener("dblclick",()=>{i.value=String(o.defaultValue??0),i.dispatchEvent(new Event("input"))}),c},select(r,e,o){const c=document.createElement("div");c.className="select-block";const i=document.createElement("span"),l=document.createElement("select");l.name="plugin-select",l.value=o.selectedValue||"";const s=o.options.map(({value:n,displayText:N})=>{const y=document.createElement("option");return y.value=n,y.innerText=N,o.selectedValue===n&&y.setAttribute("selected","true"),y});return l.addEventListener("change",n=>{e(n.target.value,n)}),i.append(r),l.append(...s),c.append(i,l),c},checkbox(r,e,o){const c=document.createElement("label"),i=document.createElement("input");return i.type="checkbox",i.checked=!!o.defaultValue,i.addEventListener("change",l=>{e(l.target.checked,l)}),c.append(r,i),c},knob(r,e,o){const c=document.createElement("div");c.className="knob-container";const i=document.createElement("div");i.className="label",i.append(r);const l=document.createElement("div"),s=document.createElement("div"),n=document.createElement("div");l.className="knob",s.className="arc",n.className="indicator",l.append(s,n);const N=document.createElement("div");N.className="value";const y=(o.max??1)*100;let g=o.value*100,S=!1,b=0;const w=()=>{const a=g*270/y-135;s.style.setProperty("--angle",`${270/y*g}deg`),n.style.transform=`translateX(-50%) rotate(${a}deg)`,N.textContent=o.formatter?.(g/100)||String(g)},I=(a,f)=>{g=a,g=Math.max(o.min||0,Math.min(y,g)),e(g/100,f),w()};return l.addEventListener("mousedown",a=>{S=!0,b=a.clientY}),l.addEventListener("dblclick",a=>{I(o.defaultValue*100,a)}),l.addEventListener("wheel",a=>{const f=-1*Math.sign(a.deltaY);g+=f*2,I(g,a)}),document.addEventListener("mouseup",()=>S=!1),document.addEventListener("mousemove",a=>{if(!S)return;const f=b-a.clientY;b=a.clientY,g+=f*(o.speed||.5),I(g,a)}),w(),c.append(i,l,N),c}}),pe=80,F=1024*4,he=r=>Math.sqrt(r.reduce((e,o)=>e+o*o,0)/r.length),me=r=>{const e=document.getElementById("audio-volume-meter"),o=e.getContext("2d"),c=r.createAnalyser();c.fftSize=F;const i=r.createAnalyser();i.fftSize=F;const l=new Float32Array(F),s=new Float32Array(F),n=60,N=2,y=(S,b)=>{const w=he(S),I=te(w),a=-20,f=-6,u=(Math.min(a,I)+n)/n,m=(Math.min(f,I)+n)/n,h=(Math.min(0,I)+n)/n,C=e.height-u*e.height,k=e.height-m*e.height,O=e.height-h*e.height,M=e.width/2+N*(b*2-1);o.fillStyle="#ff0000",o.fillRect(b*M,O,e.width/2,e.height),o.fillStyle="#ffbb4a",o.fillRect(b*M,k,e.width/2,e.height),o.fillStyle="#50bb4a",o.fillRect(b*M,C,e.width/2,e.height)},g=()=>{requestAnimationFrame(g),c.getFloatTimeDomainData(l),i.getFloatTimeDomainData(s),o.clearRect(0,0,e.width,e.height),y(l,0),y(s,1);const S=e.height/(n/5);for(let b=0;b<=n/5;b++){const w=b*S;o.fillStyle="#fefefe",o.font="9px Consolas",o.fillText(`${b*5}`,1,w-2),o.fillStyle="#888",o.fillRect(0,w,10,1)}};return g(),{connect(S){const b=r.createChannelSplitter(2);b.connect(c,0),b.connect(i,1),S.connect(b)},resize(S,b){e.width=S,e.height=b},getWidth:()=>pe}};class Y{constructor(e){this.audioContext=e,this.input=this.audioContext.createGain(),this.output=this.audioContext.createGain();const o=re(0),c={min:0,max:2,defaultValue:o,value:o,speed:.3,formatter:l=>`${te(l).toFixed(1)} dB`},i=(l,s)=>{l.gain.setValueAtTime(s,this.audioContext.currentTime)};this.inputSlider=this.builder.knob("Input Gain",l=>i(this.input,l),c),this.outputSlider=this.builder.knob("Output Gain",l=>i(this.output,l),c)}input;output;builder=P();inputSlider;outputSlider;get name(){return"Audio Graph Node"}get[Symbol.toStringTag](){return"AudioGraphNode"}}class G extends Y{dryNode;wetNode;mixValue=1;mixSliderElement;constructor(e){super(e),this.dryNode=this.audioContext.createGain(),this.wetNode=this.audioContext.createGain(),this.setMixValue(1),this.input.connect(this.dryNode),this.wetNode.connect(this.output),this.dryNode.connect(this.output),this.mixSliderElement=P().knob("Mix",o=>this.setMixValue(o),{max:1,value:this.getMixValue(),defaultValue:1})}getMixValue(){return this.mixValue}setMixValue(e){this.mixValue=e,this.dryNode.gain.value=1-this.mixValue,this.wetNode.gain.value=this.mixValue}render(e){e.innerHTML=""}get name(){return"Unknown Audio Plugin"}get[Symbol.toStringTag](){return"Audio Plugin"}}class ge extends Y{mono=!1;channelMerger;stereoPanner;panKnob;get name(){return"Input Node"}constructor(e){super(e),this.channelMerger=e.createChannelMerger(),this.stereoPanner=e.createStereoPanner(),this.input.connect(this.stereoPanner),this.stereoPanner.connect(this.output),this.panKnob=this.builder.knob("Pan",o=>{this.stereoPanner.pan.setValueAtTime(o*2-1,this.audioContext.currentTime),console.log("stereo panner:",this.stereoPanner.pan.value,o)},{max:1,defaultValue:.5,value:(this.stereoPanner.pan.value+1)/2,formatter:o=>{let c="C";return o<.5?c="L":o>.5&&(c="R"),`${Math.abs(o*200-100).toFixed(0)} ${c}`}})}setMono(e){this.mono=e,e?(this.input.disconnect(this.stereoPanner),this.input.connect(this.channelMerger,0,0),this.input.connect(this.channelMerger,0,1),this.channelMerger.connect(this.stereoPanner)):(this.input.disconnect(this.channelMerger),this.channelMerger.disconnect(),this.input.connect(this.stereoPanner))}render(e){e.innerHTML="";const o=P(),c=o.createContainer(o.checkbox("Mono: ",i=>this.setMono(i),{defaultValue:this.mono}),this.panKnob,this.inputSlider,this.outputSlider);e.append(c)}}class ye extends Y{constructor(e){super(e),this.input.connect(this.output)}get name(){return"Output Node"}render(e){e.innerHTML="";const c=P().createContainer(this.inputSlider,this.outputSlider);e.append(c)}}const be=(r,e,o)=>{const c=document.getElementById("context-menu"),i=document.createElement("ul");c.innerHTML="",c.append(i),r.addEventListener("mousedown",()=>{c.style.display="none"}),r.addEventListener("contextmenu",l=>{l.preventDefault();const{clientX:s,clientY:n}=l;if(!e(l))return;const N=o.map(y=>{if(!y.canShow?.())return;const g=document.createElement("li");return g.dataset.action=y.key,g.innerText=y.displayText,g.addEventListener("click",S=>{S.preventDefault(),y.handler(S),c.style.display="none"}),g}).filter((y=>y));N.length&&(i.innerHTML="",i.append(...N),c.style.display="block",c.style.left=`${s}px`,c.style.top=`${n}px`)})},v={NODE_WIDTH:150,NODE_HEIGHT:50,CONNECTOR_GAP:15,CONNECTOR_RADIUS:5,CONNNECTOR_RADIUS_HOVERED:10},Ee=r=>{const e={nodes:[{type:"input",id:U(),instance:new ge(r.audioContext),position:{x:0,y:0},connections:{}},{type:"output",id:U(),instance:new ye(r.audioContext),position:{x:0,y:0},connections:{}}]},[o,c]=e.nodes;o.connections[c.id]=1;const i={isConnector:!1,isInput:!1,nodeId:""},l=document.getElementById("audio-plugin"),s=document.getElementById("graph"),n=s.getContext("2d");be(s,()=>!!e.selectedNode,[{key:"delete",displayText:"Delete node",canShow:()=>e.selectedNode?.type==="plugin",handler:()=>{if(!e.selectedNode||e.selectedNode.type!=="plugin")return;console.log("Deleting:",e.selectedNode,e.nodes);const a=new Map;let f=-1;e.nodes.forEach((u,m)=>{if(a.set(u.id,u),u.id===e.selectedNode.id){f=m;return}if(e.selectedNode.id in u.connections){try{u.instance.output.disconnect(e.selectedNode.instance.input)}catch{}delete u.connections[e.selectedNode.id]}});for(const u in e.selectedNode.connections){const m=a.get(u);if(m)try{e.selectedNode.instance.output.disconnect(m.instance.input)}catch{}}delete e.selectedNode,e.nodes.splice(f,1),l.innerHTML=""}}]);const N=()=>{n.clearRect(0,0,s.width,s.height);for(const a of e.nodes){const f=e.selectedNode?.id===a.id;n.beginPath(),n.fillStyle="transparent",n.strokeStyle=f?"steelblue":"#555",n.roundRect(a.position.x,a.position.y,v.NODE_WIDTH,v.NODE_HEIGHT,5),n.closePath(),n.stroke(),n.fill();const u=i.isConnector&&i.nodeId===a.id;if(a.type!=="input"){const h=u&&i.isInput?v.CONNNECTOR_RADIUS_HOVERED:v.CONNECTOR_RADIUS;n.fillStyle="#555555",n.beginPath(),n.arc(a.position.x-v.CONNECTOR_GAP,a.position.y+v.NODE_HEIGHT/2,h,0,Math.PI*2),n.fill()}if(a.type!=="output"){const h=u&&!i.isInput?v.CONNNECTOR_RADIUS_HOVERED:v.CONNECTOR_RADIUS;n.fillStyle="#555555",n.beginPath(),n.arc(a.position.x+v.NODE_WIDTH+v.CONNECTOR_GAP,a.position.y+v.NODE_HEIGHT/2,h,0,Math.PI*2),n.fill()}n.fillStyle="#FFFFFF",n.font="14px Arial";const m=a.instance.name;n.fillText(m,a.position.x+10,a.position.y+25);for(const h in a.connections){const C=e.nodes.find(k=>k.id===h);if(C){const k=a.position.x+v.NODE_WIDTH+v.CONNECTOR_GAP,O=a.position.y+v.NODE_HEIGHT/2,M=C.position.x-v.CONNECTOR_GAP,D=C.position.y+v.NODE_HEIGHT/2,B=k+v.NODE_HEIGHT,d=O,p=M-v.NODE_HEIGHT,E=D;n.strokeStyle="#888888",n.beginPath(),n.moveTo(k,O),n.bezierCurveTo(B,d,p,E,M,D),n.stroke()}}}if(e.linking){const{NODE_WIDTH:a,NODE_HEIGHT:f,CONNECTOR_GAP:u}=v,m=e.nodes.find(k=>k.id===e.linking.nodeSourceId),h=e.linking.isSourceInput?m.position.x-u:m.position.x+a+u,C=m.position.y+f/2;n.strokeStyle="steelblue",n.beginPath(),n.moveTo(h,C),n.lineTo(e.linking.mouseX,e.linking.mouseY),n.stroke()}requestAnimationFrame(N)};N();const y=(a,f)=>{for(const u of e.nodes){const{x:m,y:h}=u.position;if(m<=a&&m+v.NODE_WIDTH>=a&&h<=f&&h+v.NODE_HEIGHT>=f)return u}return null},g=(a,f)=>{const u=v.CONNNECTOR_RADIUS_HOVERED;for(const m of e.nodes){const{x:h,y:C}=m.position;if(m.type!=="input"&&Q(a,f,h-v.CONNECTOR_GAP,C+v.NODE_HEIGHT/2)<=u)return{node:m,input:!0};if(m.type!=="output"&&Q(a,f,h+v.NODE_WIDTH+v.CONNECTOR_GAP,C+v.NODE_HEIGHT/2)<=u)return{node:m,input:!1}}return null},S=a=>{a.instance.render(l)},b=a=>{s.style.cursor=a};s.addEventListener("mousedown",a=>{const{offsetX:f,offsetY:u}=a,m=g(f,u);if(m){e.linking={nodeSourceId:m.node.id,isSourceInput:m.input,mouseX:f,mouseY:u},b("grabbing");return}const h=y(f,u);if(h){b("grabbing"),e.selectedNode?.id!==h.id&&S(h),e.selectedNode=h,e.draggingAnchor={x:f-h.position.x,y:u-h.position.y};return}delete e.selectedNode,l.innerHTML=""}),s.addEventListener("mousemove",a=>{const{offsetX:f,offsetY:u}=a,m=g(f,u);if(m)i.nodeId=m.node.id,i.isInput=m.input,i.isConnector=!0,s.style.cursor="pointer";else{i.isConnector=!1;const h=y(f,u);h?(s.style.cursor="pointer",i.nodeId=h.id):(s.style.cursor="default",i.nodeId="")}e.linking&&(e.linking.mouseX=f,e.linking.mouseY=u,b("grabbing")),e.draggingAnchor&&e.selectedNode&&(e.selectedNode.position.x=f-e.draggingAnchor.x,e.selectedNode.position.y=u-e.draggingAnchor.y)});const w=(a,f)=>{if(console.log("Creating new connection between",a,f),a.connections[f.id])return a.type==="plugin"&&a.instance&&a.instance.output.disconnect(),delete a.connections[f.id],r.onUpdate(e),!0;const u=[f.id],m=new Set;for(;u.length;){const h=u.pop();if(h){if(h===a.id)return console.warn("The connection between nodes (%s -> %s) will cause a circular dependency",a.id,f.id),!1;if(!m.has(h)){m.add(h);const C=e.nodes.find(k=>k.id===h);u.push(...Object.keys(C.connections));continue}}}return a.connections[f.id]=1,r.onUpdate(e),!0};s.addEventListener("mouseup",a=>{const{offsetX:f,offsetY:u}=a;if(e.draggingAnchor&&e.selectedNode&&(b("default"),delete e.draggingAnchor),e.linking){const m=g(f,u),h=e.nodes.find(k=>k.id===e.linking.nodeSourceId),{isSourceInput:C}=e.linking;m&&h&&m.input!==e.linking.isSourceInput&&(C?w(m.node,h):w(h,m.node)),delete e.linking}});const I=()=>{s.width=document.body.clientWidth-20,s.height=350,o.position.x=50,o.position.y=s.height/2,c.position.x=s.width-200,c.position.y=s.height/2};return I(),window.addEventListener("resize",I),{apply(a,f){o.instance.output.disconnect(),c.instance.output.connect(f),a.connect(o.instance.input);for(const u of e.nodes){if(u.type==="output")continue;const m=u.instance.output;for(const h in u.connections){const C=e.nodes.find(O=>O.id===h);if(!C||C.type==="input"){delete u.connections[h];continue}const k=C.instance.input;m.connect(k)}}},analyze(a){a(c.instance.output)},addPlugin(a){const f={id:U(),type:"plugin",position:{x:s.width/2,y:s.height/2},instance:a,connections:{}};return e.nodes.push(f),!0}}};class W extends G{static NAME="Equalizer (7 Band)";get name(){return W.NAME}bands;constructor(e){super(e),this.bands=[80,250,500,1500,3e3,5e3,8e3].map((o,c)=>{const i=this.audioContext.createBiquadFilter();return c===0?i.type="lowshelf":c===6?i.type="highshelf":i.type="peaking",i.frequency.value=o,i.Q.value=1,i}),this.bands.reduce((o,c)=>(o.connect(c),c)),this.input.connect(this.bands[0]),this.bands.at(-1)?.connect(this.wetNode)}render(e){const o={min:-12,max:12,step:.1,defaultValue:0},c=P(),i=this.bands.map(s=>c.slider(`${s.frequency.value}Hz`,n=>s.gain.setValueAtTime(n,this.audioContext.currentTime+.01),{...o,formatter:n=>`${n.toFixed(1)} dB`,value:s.gain.value})),l=c.createContainer(...i,this.mixSliderElement,this.inputSlider,this.outputSlider);e.innerHTML="",e.appendChild(l)}}const J=[{title:"Church",path:"/impulse_responses/Church Schellingwoude/Church Schellingwoude.wav"},{title:"Factory Hall",path:"/impulse_responses/Factory Hall/Factory Hall/Factory Hall.wav"},{title:"Claustrofobia v1.1",path:"/impulse_responses/Claustrofobia v1.1/Dustbin 3 mono/Dustbin 3.C.wav"}].map(r=>({...r,path:de(r.path)}));class $ extends G{static NAME="Reverb (IR)";get name(){return $.NAME}convolver;selectedIRPath="";constructor(e){super(e),this.convolver=this.audioContext.createConvolver(),this.input.connect(this.convolver).connect(this.wetNode)}setIRBuffer(e){this.convolver.buffer=e}render(e){const o=P(),c=J.map(s=>({value:s.path,displayText:s.title})),i=s=>{this.selectedIRPath!==s&&(this.selectedIRPath=s,console.log("(reverb): Loading IR from path:",s),fe(s).then(n=>this.audioContext.decodeAudioData(n)).then(n=>this.setIRBuffer(n)).catch(n=>console.error("Error fetching IR audio buffer:",n)))};this.selectedIRPath||i(J[0].path);const l=o.createContainer(o.select("Type",i,{options:c,selectedValue:this.selectedIRPath}),this.mixSliderElement);e.innerHTML="",e.appendChild(l)}}class q extends G{static NAME="Delay";get name(){return q.NAME}maxDelayTime=5;delay;feedback;constructor(e){super(e),this.delay=e.createDelay(this.maxDelayTime),this.feedback=e.createGain(),this.delay.delayTime.value=.5,this.feedback.gain.value=.2,this.delay.connect(this.feedback),this.feedback.connect(this.delay),this.input.connect(this.delay),this.delay.connect(this.wetNode)}render(e){const o=P(),c=o.createContainer(o.slider("Feedback",i=>this.feedback.gain.value=i,{min:0,max:2,value:this.feedback.gain.value,defaultValue:.2,step:.01,formatter:i=>`${(i*100).toFixed(0)}%`}),o.slider("Delay",i=>this.delay.delayTime.value=i,{min:0,max:this.maxDelayTime,value:this.delay.delayTime.value,defaultValue:.5,step:.1,formatter:i=>`${i.toFixed(1)} sec`}),this.mixSliderElement,this.inputSlider,this.outputSlider);e.innerHTML="",e.appendChild(c)}}class Ne extends G{get name(){return"Compressor"}compressor;blockElement;constructor(e){super(e),this.compressor=e.createDynamicsCompressor(),this.input.connect(this.compressor),this.compressor.connect(this.wetNode);const o=P(),c=N=>`${N.toFixed(1)} dB`,i=N=>`${(N*1e3).toFixed(1)} ms`,s={threshold:{min:-60,max:0,defaultValue:0,format:c,type:"log"},knee:{min:0,max:40,defaultValue:18,format:c,type:"log"},ratio:{min:1,max:20,defaultValue:4,format:N=>N.toFixed(1),type:"linear"},attack:{min:.005,max:.25,defaultValue:.005,speed:.2,format:i,type:"exp"},release:{min:.005,max:.25,defaultValue:.005,speed:.2,format:i,type:"exp"}},n=N=>{let y=ae;return N==="log"?y=ce:N==="exp"&&(y=le),y};this.blockElement=o.block(Object.keys(s).map(N=>{const y=N,g=s[y],S=this.compressor[y],b=n(g.type);return o.knob(y.charAt(0).toUpperCase()+y.slice(1),w=>S.setValueAtTime(b(w,g.min,g.max),this.audioContext.currentTime),{defaultValue:.5,value:.5,speed:"speed"in g?g.speed:.5,formatter:w=>g.format?.(b(w,g.min,g.max))})}))}render(e){const o=P(),c=o.createContainer(o.splitterHorizontal(),this.blockElement,o.splitterHorizontal(),this.mixSliderElement,this.inputSlider,this.outputSlider);e.innerHTML="",e.appendChild(c)}}const ne=44100,xe={sampleRate:ne},t={recording:!1,playback:null,playbackOffsetSeconds:0,selection:{selected:!1,selecting:!1,start:0,end:0},audioContext:new AudioContext(xe),rawAudioBuffer:null,sourceNode:null,currentFile:null},X={PLAY:"Space"},ee=[{id:"reverb",name:"Reverb",getInstance:r=>new $(r)},{id:"equalizer",name:"EQ (7 Band)",getInstance:r=>new W(r)},{id:"delay",name:"Delay",getInstance:r=>new q(r)},{id:"compressor",name:"Compressor",getInstance:r=>new Ne(r)}],Se=()=>(t.playback?t.audioContext.currentTime-t.playback.startedTime:0)+t.playbackOffsetSeconds;window.addEventListener("load",async()=>{const r=document.getElementById("load-sample"),e=document.getElementById("sample-file-input"),o=document.getElementById("loop-playback"),c=document.getElementById("record"),i=document.getElementById("play"),l=document.getElementById("add-plugin-select"),s=document.querySelector("canvas"),n=s.getContext("2d"),N=me(t.audioContext),y=Ee({audioContext:t.audioContext,onUpdate:d=>console.log("Audio Graph Updated!",d)});(()=>{for(const d of ee){const p=document.createElement("option");p.value=d.id,p.innerText=d.name,l.add(p)}l.addEventListener("change",d=>{const p=ee.find(E=>E.id===d.target?.value);p&&(console.log("Adding plugin:",p),y.addPlugin(p.getInstance(t.audioContext)),l.value="")})})();let g=0,S=0,b=1,w=null;const I=d=>{if(!t.rawAudioBuffer)return 0;const E=(d-S)/(s.width*b)*t.rawAudioBuffer.length;return Math.round(E)},a=()=>{i.innerText=(t.playback?"Pause":"Play")+` (${X.PLAY})`},f=d=>{if(!t.sourceNode)return 0;let p=t.playbackOffsetSeconds+d;if(t.sourceNode.loop)if(t.selection.selected){const E=t.sourceNode.loopEnd-t.sourceNode.loopStart,x=(p-t.sourceNode.loopStart)%E+E%E;p=t.sourceNode.loopStart+x}else p%=t.rawAudioBuffer.duration;return p},u=()=>{if(!t.playback)return!1;if(t.sourceNode){const d=t.audioContext.currentTime-t.playback.startedTime;t.playbackOffsetSeconds=f(d),t.sourceNode.onended=null,t.sourceNode.stop(),t.sourceNode.disconnect(),t.sourceNode=null,console.log("Pause! Played seconds: (%f sec, offset = %f sec)",d,t.playbackOffsetSeconds,t.rawAudioBuffer.duration)}t.playback=null,a()},m=()=>{if(t.playback)return;if(!t.rawAudioBuffer){console.log("Cannot play audio without audio buffer",t);return}const{length:d,duration:p}=t.rawAudioBuffer,E=t.selection.start/d*p,x=t.selection.end/d*p;t.sourceNode=t.audioContext.createBufferSource(),t.sourceNode.buffer=t.rawAudioBuffer,t.sourceNode.loop=o.checked,t.sourceNode.playbackRate.value=1,t.sourceNode.loopStart=Math.min(E,x),t.sourceNode.loopEnd=Math.max(E,x),y.apply(t.sourceNode,t.audioContext.destination),y.analyze(N.connect),t.sourceNode.onended=A=>{t.playback&&(console.log("Playback ended event",{event:A,state:t}),t.playback=null,t.playbackOffsetSeconds=t.selection.selected?Math.min(E,x):0,t.sourceNode?.stop(),t.sourceNode?.disconnect(),t.sourceNode=null,a())};let T=0;if(t.selection.selected){const A=t.sourceNode.loop?t.sourceNode.loopStart:t.playbackOffsetSeconds;T=t.sourceNode.loopEnd-A}t.sourceNode.start(0,t.playbackOffsetSeconds,t.selection.selected&&!t.sourceNode.loop?T:void 0),t.playback={startedTime:t.audioContext.currentTime},a()},h=d=>{u(),b=1,S=0,g=0,t.rawAudioBuffer=d,w=null},C=()=>{const d=document.createElement("canvas");d.width=s.width,d.height=s.height;const p=d.getContext("2d");if(!t.rawAudioBuffer)return d;const E=t.rawAudioBuffer.getChannelData(0),x=s.width*b,T=E.length,A=Math.ceil(T/x);p.beginPath();const R=s.height/2;for(let _=0;_<s.width;_++){const K=Math.floor((_-S)/x*T),oe=Math.min(T,K+A);let V=1,z=-1;for(let L=K;L<oe&&L<E.length;L++){const H=E[L];H>z&&(z=H),H<V&&(V=H)}p.moveTo(_,(1+V)*R),p.lineTo(_,(1+z)*R)}return p.closePath(),p.strokeStyle="rgba(126, 36, 128, 1)",p.stroke(),d};let k=0;const O=d=>{if(!k)return k=d,requestAnimationFrame(O);const p=(d-k)/1e3;if(k=d,!t.rawAudioBuffer)return requestAnimationFrame(O);const E=t.rawAudioBuffer;n.clearRect(0,0,s.width,s.height),w??=C(),n.drawImage(w,0,0);const x=s.width*b;if(n.beginPath(),n.moveTo(g,0),n.lineTo(g,s.height),n.closePath(),n.strokeStyle="#6d6d6d44",n.stroke(),t.selection.selecting||t.selection.selected){const T=t.selection.start/E.length*x+S,A=t.selection.end/E.length*x+S;n.fillStyle="rgba(67, 140, 235, 0.5)",n.fillRect(T,0,A-T,s.height),n.beginPath(),n.moveTo(T,0),n.lineTo(T,s.height),n.closePath(),n.lineWidth=2,n.strokeStyle="rgba(67, 140, 235, 1)",n.stroke(),n.beginPath(),n.moveTo(A,0),n.lineTo(A,s.height),n.closePath(),n.lineWidth=2,n.strokeStyle="rgba(67, 140, 235, 1)",n.stroke()}if(t.playback&&t.sourceNode){const T=t.audioContext.currentTime-t.playback.startedTime,R=f(T)*x/t.rawAudioBuffer.duration+S;n.beginPath(),n.moveTo(R,0),n.lineTo(R,s.height),n.closePath(),n.strokeStyle="#ffffffff",n.lineWidth=2,n.stroke()}else if(t.playbackOffsetSeconds>0){const T=t.playbackOffsetSeconds*x/t.rawAudioBuffer.duration+S;n.beginPath(),n.moveTo(T,0),n.lineTo(T,s.height),n.closePath(),n.strokeStyle="#ffffffff",n.lineWidth=2,n.stroke()}if(n.font="14px Monospace",n.fillStyle="rgba(46, 204, 6, 1)",n.fillText("FPS: "+(1/p).toFixed(0),14,24),t.currentFile){const T=`File: ${t.currentFile.name} | ${(t.currentFile.size/1024/1024).toFixed(2)} MB`,A=n.measureText(T);n.fillStyle="rgba(255, 255, 255, 1)",n.fillText(T,s.width-A.width-10,24)}n.save(),n.fillStyle="#fff",n.textAlign="center",n.textBaseline="middle",n.fillText(ue(Se()),s.width/2,24),n.restore(),requestAnimationFrame(O)};requestAnimationFrame(O);const M=()=>{const d={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,channelCount:1,sampleRate:ne}};let p=null;return async()=>{if(t.recording)p&&(p.stop(),p=null),t.recording=!1;else{const E=await navigator.mediaDevices.getUserMedia(d).catch(console.error);if(!E)return;let x=[];p=new MediaRecorder(E,{mimeType:"audio/webm"}),p.ondataavailable=T=>{console.log("New recorded data of size:",T.data.size),x.push(T.data)},p.onstop=()=>{const T=new Blob(x,{type:"audio/webm"});x=[],T.arrayBuffer().then(A=>t.audioContext.decodeAudioData(A)).then(A=>h(A)).then(()=>t.currentFile=null).catch(A=>console.error("Unable to get an array buffer from MediaRecorder:",A))},p.start(),t.recording=!0}c.innerText=t.recording?"Stop":"Record"}};c.onclick=M(),r.addEventListener("click",()=>e.click()),e.addEventListener("change",()=>{const[d]=e.files||[];if(!d)return;const p=ie(d);if(!p.ok){console.error(p.message,d);return}const E=new FileReader;E.onload=()=>{E.result instanceof ArrayBuffer&&t.audioContext.decodeAudioData(E.result).then(h).then(()=>t.currentFile=d).catch(x=>console.error("Error during decoding an audio file:",x))},E.onerror=x=>{console.error("File reading error",x)},E.onprogress=x=>{console.log("File reading progress:",x)},E.readAsArrayBuffer(d)});const D=()=>{t.playback?u():m(),i.innerText=(t.playback?"Pause":"Play")+` (${X.PLAY})`};i.addEventListener("click",D),window.addEventListener("keydown",d=>{if(d.code===X.PLAY)return d.preventDefault(),D()}),s.addEventListener("mousemove",d=>{g=d.offsetX,t.rawAudioBuffer&&t.selection.selecting&&(t.selection.end=I(d.offsetX))}),s.addEventListener("mousedown",d=>{if(t.rawAudioBuffer){t.selection.selecting=!0;const p=I(d.offsetX);t.selection.start=p,t.selection.end=p}}),window.addEventListener("mouseup",d=>{const E=d.target&&d.target instanceof HTMLCanvasElement?d.offsetX:g;if(t.rawAudioBuffer&&t.selection.selecting){t.selection.end=I(E),t.selection.selecting=!1,t.selection.selected=t.selection.start!==t.selection.end,console.log("Selection event on mouseup:",t.selection);const x=Math.max(0,Math.min(t.selection.start,t.selection.end)/t.rawAudioBuffer.length*t.rawAudioBuffer.duration);t.playback?(u(),t.playbackOffsetSeconds=x,m()):t.playbackOffsetSeconds=x}}),s.addEventListener("wheel",d=>{if(d.preventDefault(),!t.rawAudioBuffer)return!1;const p=d.ctrlKey?.5:.1,E=1-Math.sign(d.deltaY)*p,x=Math.max(1,b*E),T=s.width*x-s.width,A=(g-S)/(s.width*b);S=Math.max(-T,Math.min(0,g-A*s.width*x)),w=null,b=x});const B=()=>{const d=N.getWidth();N.resize(d,200),s.width=document.body.clientWidth-d-30,s.height=200,w=null};window.addEventListener("resize",B),B()});
