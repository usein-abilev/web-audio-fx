(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const l of s)if(l.type==="childList")for(const i of l.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function o(s){const l={};return s.integrity&&(l.integrity=s.integrity),s.referrerPolicy&&(l.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?l.credentials="include":s.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function r(s){if(s.ep)return;s.ep=!0;const l=o(s);fetch(s.href,l)}})();const q=["audio/mpeg","audio/ogg","audio/wave","audio/wav","audio/x-wav","audio/mp4","audio/flac"],K=8*1024*1024,te=a=>a?q.includes(a.type)?a.size>K?{ok:!1,message:"File size has exceeded the MAX_AUDIO_FILE_SIZE constraint: "+K}:{ok:!0}:{ok:!1,message:"Unsupported file type. Supported MIME-types: "+q}:{ok:!1,message:"File not found"},ne=a=>20*Math.log10(a),oe=a=>10**(a/20),ie=(a,e,o)=>e+(o-e)*a,se=(a,e,o)=>e+(o-e)*a**2.5,re=(a,e,o)=>e*(o/e)**a,V=()=>{const a=Date.now().toString(16),e=Math.floor(Math.random()*2**52).toString(16);return`${a}-${e}`},j=(a,e,o,r)=>Math.sqrt((o-a)**2+(r-e)**2),ae=async a=>{try{return await(await fetch(a)).arrayBuffer()}catch(e){throw console.error("Error fetching audio array buffer:",e),new Error("Error fetching audio data")}},A=()=>({createContainer(...a){const e=document.createElement("div");return e.className="plugin-container",a.forEach(o=>e.appendChild(o)),e},block(a){const e=document.createElement("div");return e.className="flex-block",e.append(...a),e},splitterHorizontal(){const a=document.createElement("div");return a.className="horizontal-splitter",a},slider(a,e,o={defaultValue:0,value:0}){const r=document.createElement("div"),s=document.createElement("input"),l=document.createElement("label"),i=document.createElement("label"),n=o.value??o.defaultValue??0;return typeof o.formatter=="function"?i.append(o.formatter(n)):i.innerText=n.toFixed(1),r.className="band",s.type="range",s.value=String(n),console.log("Set input value for '%s'",a,s.value,o.value),l.append(a),r.append(s,i,l),Object.assign(s,o),s.addEventListener("input",E=>{const m=+E.target.value;e(m,E),i.innerHTML="",typeof o.formatter=="function"?i.append(o.formatter(m)):i.innerText=m.toFixed(1)}),r.addEventListener("dblclick",()=>{s.value=String(o.defaultValue??0),s.dispatchEvent(new Event("input"))}),r},select(a,e,o){const r=document.createElement("div");r.className="select-block";const s=document.createElement("span"),l=document.createElement("select");l.name="plugin-select",l.value=o.selectedValue||"";const i=o.options.map(({value:n,displayText:E})=>{const m=document.createElement("option");return m.value=n,m.innerText=E,o.selectedValue===n&&m.setAttribute("selected","true"),m});return l.addEventListener("change",n=>{e(n.target.value,n)}),s.append(a),l.append(...i),r.append(s,l),r},checkbox(a,e,o){const r=document.createElement("label"),s=document.createElement("input");return s.type="checkbox",s.checked=!!o.defaultValue,s.addEventListener("change",l=>{e(l.target.checked,l)}),r.append(a,s),r},knob(a,e,o){const r=document.createElement("div");r.className="knob-container";const s=document.createElement("div");s.className="label",s.append(a);const l=document.createElement("div"),i=document.createElement("div"),n=document.createElement("div");l.className="knob",i.className="arc",n.className="indicator",l.append(i,n);const E=document.createElement("div");E.className="value";const m=(o.max??1)*100;let y=o.value*100,S=!1,w=0;const O=()=>{const I=y*270/m-135;i.style.setProperty("--angle",`${270/m*y}deg`),n.style.transform=`translateX(-50%) rotate(${I}deg)`,E.textContent=o.formatter?.(y/100)||String(y)};return l.addEventListener("mousedown",I=>{S=!0,w=I.clientY}),l.addEventListener("dblclick",I=>{y=o.defaultValue*100,e(y/100,I),O()}),document.addEventListener("mouseup",()=>S=!1),document.addEventListener("mousemove",I=>{if(!S)return;const c=w-I.clientY;w=I.clientY,y+=c*(o.speed||.5),y=Math.max(o.min||0,Math.min(m,y)),e(y/100,I),O()}),O(),r.append(s,l,E),r}});class U{constructor(e){this.audioContext=e,this.input=this.audioContext.createGain(),this.output=this.audioContext.createGain();const o=oe(0),r={min:0,max:2,defaultValue:o,value:o,speed:.3,formatter:l=>`${ne(l).toFixed(1)} dB`},s=(l,i)=>{l.gain.setValueAtTime(i,this.audioContext.currentTime)};this.inputSlider=this.builder.knob("Input Gain",l=>s(this.input,l),r),this.outputSlider=this.builder.knob("Output Gain",l=>s(this.output,l),r)}input;output;builder=A();inputSlider;outputSlider;get name(){return"Audio Graph Node"}get[Symbol.toStringTag](){return"AudioGraphNode"}}class _ extends U{dryNode;wetNode;mixValue=1;mixSliderElement;constructor(e){super(e),this.dryNode=this.audioContext.createGain(),this.wetNode=this.audioContext.createGain(),this.setMixValue(1),this.input.connect(this.dryNode),this.wetNode.connect(this.output),this.dryNode.connect(this.output),this.mixSliderElement=A().knob("Mix",o=>this.setMixValue(o),{max:1,value:this.getMixValue(),defaultValue:1})}getMixValue(){return this.mixValue}setMixValue(e){this.mixValue=e,this.dryNode.gain.value=1-this.mixValue,this.wetNode.gain.value=this.mixValue}render(e){e.innerHTML=""}get name(){return"Unknown Audio Plugin"}get[Symbol.toStringTag](){return"Audio Plugin"}}class ce extends U{mono=!1;channelMerger;stereoPanner;panKnob;get name(){return"Input Node"}constructor(e){super(e),this.channelMerger=e.createChannelMerger(),this.stereoPanner=e.createStereoPanner(),this.input.connect(this.stereoPanner),this.stereoPanner.connect(this.output),this.panKnob=this.builder.knob("Pan",o=>{this.stereoPanner.pan.setValueAtTime(o*2-1,this.audioContext.currentTime),console.log("stereo panner:",this.stereoPanner.pan.value,o)},{max:1,defaultValue:.5,value:(this.stereoPanner.pan.value+1)/2,formatter:o=>{let r="C";return o<.5?r="L":o>.5&&(r="R"),`${Math.abs(o*200-100).toFixed(0)} ${r}`}})}setMono(e){this.mono=e,e?(this.input.disconnect(this.stereoPanner),this.input.connect(this.channelMerger,0,0),this.input.connect(this.channelMerger,0,1),this.channelMerger.connect(this.stereoPanner)):(this.input.disconnect(this.channelMerger),this.channelMerger.disconnect(),this.input.connect(this.stereoPanner))}render(e){e.innerHTML="";const o=A(),r=o.createContainer(o.checkbox("Mono: ",s=>this.setMono(s),{defaultValue:this.mono}),this.panKnob,this.inputSlider,this.outputSlider);e.append(r)}}class le extends U{constructor(e){super(e),this.input.connect(this.output)}get name(){return"Output Node"}render(e){e.innerHTML="";const r=A().createContainer(this.inputSlider,this.outputSlider);e.append(r)}}const de=(a,e,o)=>{const r=document.getElementById("context-menu"),s=document.createElement("ul");r.innerHTML="",r.append(s),a.addEventListener("mousedown",()=>{r.style.display="none"}),a.addEventListener("contextmenu",l=>{l.preventDefault();const{clientX:i,clientY:n}=l;if(!e(l))return;const E=o.map(m=>{if(!m.canShow?.())return;const y=document.createElement("li");return y.dataset.action=m.key,y.innerText=m.displayText,y.addEventListener("click",S=>{S.preventDefault(),m.handler(S),r.style.display="none"}),y}).filter((m=>m));E.length&&(s.innerHTML="",s.append(...E),r.style.display="block",r.style.left=`${i}px`,r.style.top=`${n}px`)})},x={NODE_WIDTH:150,NODE_HEIGHT:50,CONNECTOR_GAP:15,CONNECTOR_RADIUS:5,CONNNECTOR_RADIUS_HOVERED:10},ue=a=>{const e={nodes:[{type:"input",id:V(),instance:new ce(a.audioContext),position:{x:0,y:0},connections:{}},{type:"output",id:V(),instance:new le(a.audioContext),position:{x:0,y:0},connections:{}}]},[o,r]=e.nodes;o.connections[r.id]=1;const s={isConnector:!1,isInput:!1,nodeId:""},l=document.getElementById("audio-plugin"),i=document.getElementById("graph"),n=i.getContext("2d");de(i,()=>!!e.selectedNode,[{key:"delete",displayText:"Delete node",canShow:()=>e.selectedNode?.type==="plugin",handler:()=>{if(!e.selectedNode||e.selectedNode.type!=="plugin")return;console.log("Deleting:",e.selectedNode,e.nodes);const c=new Map;let g=-1;e.nodes.forEach((u,p)=>{if(c.set(u.id,u),u.id===e.selectedNode.id){g=p;return}if(e.selectedNode.id in u.connections){try{u.instance.output.disconnect(e.selectedNode.instance.input)}catch{}delete u.connections[e.selectedNode.id]}});for(const u in e.selectedNode.connections){const p=c.get(u);if(p)try{e.selectedNode.instance.output.disconnect(p.instance.input)}catch{}}delete e.selectedNode,e.nodes.splice(g,1),l.innerHTML=""}}]);const E=()=>{n.clearRect(0,0,i.width,i.height);for(const c of e.nodes){const g=e.selectedNode?.id===c.id;n.beginPath(),n.fillStyle="transparent",n.strokeStyle=g?"steelblue":"#555",n.roundRect(c.position.x,c.position.y,x.NODE_WIDTH,x.NODE_HEIGHT,5),n.closePath(),n.stroke(),n.fill();const u=s.isConnector&&s.nodeId===c.id;if(c.type!=="input"){const h=u&&s.isInput?x.CONNNECTOR_RADIUS_HOVERED:x.CONNECTOR_RADIUS;n.fillStyle="#555555",n.beginPath(),n.arc(c.position.x-x.CONNECTOR_GAP,c.position.y+x.NODE_HEIGHT/2,h,0,Math.PI*2),n.fill()}if(c.type!=="output"){const h=u&&!s.isInput?x.CONNNECTOR_RADIUS_HOVERED:x.CONNECTOR_RADIUS;n.fillStyle="#555555",n.beginPath(),n.arc(c.position.x+x.NODE_WIDTH+x.CONNECTOR_GAP,c.position.y+x.NODE_HEIGHT/2,h,0,Math.PI*2),n.fill()}n.fillStyle="#FFFFFF",n.font="14px Arial";const p=c.instance.name;n.fillText(p,c.position.x+10,c.position.y+25);for(const h in c.connections){const T=e.nodes.find(C=>C.id===h);if(T){const C=c.position.x+x.NODE_WIDTH+x.CONNECTOR_GAP,P=c.position.y+x.NODE_HEIGHT/2,D=T.position.x-x.CONNECTOR_GAP,M=T.position.y+x.NODE_HEIGHT/2,d=C+x.NODE_HEIGHT,f=P,b=D-x.NODE_HEIGHT,N=M;n.strokeStyle="#888888",n.beginPath(),n.moveTo(C,P),n.bezierCurveTo(d,f,b,N,D,M),n.stroke()}}}if(e.linking){const{NODE_WIDTH:c,NODE_HEIGHT:g,CONNECTOR_GAP:u}=x,p=e.nodes.find(C=>C.id===e.linking.nodeSourceId),h=e.linking.isSourceInput?p.position.x-u:p.position.x+c+u,T=p.position.y+g/2;n.strokeStyle="steelblue",n.beginPath(),n.moveTo(h,T),n.lineTo(e.linking.mouseX,e.linking.mouseY),n.stroke()}requestAnimationFrame(E)};E();const m=(c,g)=>{for(const u of e.nodes){const{x:p,y:h}=u.position;if(p<=c&&p+x.NODE_WIDTH>=c&&h<=g&&h+x.NODE_HEIGHT>=g)return u}return null},y=(c,g)=>{const u=x.CONNNECTOR_RADIUS_HOVERED;for(const p of e.nodes){const{x:h,y:T}=p.position;if(p.type!=="input"&&j(c,g,h-x.CONNECTOR_GAP,T+x.NODE_HEIGHT/2)<=u)return{node:p,input:!0};if(p.type!=="output"&&j(c,g,h+x.NODE_WIDTH+x.CONNECTOR_GAP,T+x.NODE_HEIGHT/2)<=u)return{node:p,input:!1}}return null},S=c=>{c.instance.render(l)},w=c=>{i.style.cursor=c};i.addEventListener("mousedown",c=>{const{offsetX:g,offsetY:u}=c,p=y(g,u);if(p){e.linking={nodeSourceId:p.node.id,isSourceInput:p.input,mouseX:g,mouseY:u},w("grabbing");return}const h=m(g,u);if(h){w("grabbing"),e.selectedNode?.id!==h.id&&S(h),e.selectedNode=h,e.draggingAnchor={x:g-h.position.x,y:u-h.position.y};return}delete e.selectedNode,l.innerHTML=""}),i.addEventListener("mousemove",c=>{const{offsetX:g,offsetY:u}=c,p=y(g,u);if(p)s.nodeId=p.node.id,s.isInput=p.input,s.isConnector=!0,i.style.cursor="pointer";else{s.isConnector=!1;const h=m(g,u);h?(i.style.cursor="pointer",s.nodeId=h.id):(i.style.cursor="default",s.nodeId="")}e.linking&&(e.linking.mouseX=g,e.linking.mouseY=u,w("grabbing")),e.draggingAnchor&&e.selectedNode&&(e.selectedNode.position.x=g-e.draggingAnchor.x,e.selectedNode.position.y=u-e.draggingAnchor.y)});const O=(c,g)=>{if(console.log("Creating new connection between",c,g),c.connections[g.id])return c.type==="plugin"&&c.instance&&c.instance.output.disconnect(),delete c.connections[g.id],a.onUpdate(e),!0;const u=[g.id],p=new Set;for(;u.length;){const h=u.pop();if(h){if(h===c.id)return console.warn("The connection between nodes (%s -> %s) will cause a circular dependency",c.id,g.id),!1;if(!p.has(h)){p.add(h);const T=e.nodes.find(C=>C.id===h);u.push(...Object.keys(T.connections));continue}}}return c.connections[g.id]=1,a.onUpdate(e),!0};i.addEventListener("mouseup",c=>{const{offsetX:g,offsetY:u}=c;if(e.draggingAnchor&&e.selectedNode&&(w("default"),delete e.draggingAnchor),e.linking){const p=y(g,u),h=e.nodes.find(C=>C.id===e.linking.nodeSourceId),{isSourceInput:T}=e.linking;p&&h&&p.input!==e.linking.isSourceInput&&(T?O(p.node,h):O(h,p.node)),delete e.linking}});const I=()=>{i.width=document.body.clientWidth-20,i.height=350,o.position.x=50,o.position.y=i.height/2,r.position.x=i.width-200,r.position.y=i.height/2};return I(),window.addEventListener("resize",I),{apply(c,g){o.instance.output.disconnect(),r.instance.output.connect(g),c.connect(o.instance.input);for(const u of e.nodes){if(u.type==="output")continue;const p=u.instance.output;for(const h in u.connections){const T=e.nodes.find(P=>P.id===h);if(!T||T.type==="input"){delete u.connections[h];continue}const C=T.instance.input;p.connect(C)}}},addPlugin(c){const g={id:V(),type:"plugin",position:{x:i.width/2,y:i.height/2},instance:c,connections:{}};return e.nodes.push(g),!0}}};class Y extends _{static NAME="Equalizer (7 Band)";get name(){return Y.NAME}bands;constructor(e){super(e),this.bands=[80,250,500,1500,3e3,5e3,8e3].map((o,r)=>{const s=this.audioContext.createBiquadFilter();return r===0?s.type="lowshelf":r===6?s.type="highshelf":s.type="peaking",s.frequency.value=o,s.Q.value=1,s}),this.bands.reduce((o,r)=>(o.connect(r),r)),this.input.connect(this.bands[0]),this.bands.at(-1)?.connect(this.wetNode)}render(e){const o={min:-12,max:12,step:.1,defaultValue:0},r=A(),s=this.bands.map(i=>r.slider(`${i.frequency.value}Hz`,n=>i.gain.setValueAtTime(n,this.audioContext.currentTime+.01),{...o,formatter:n=>`${n.toFixed(1)} dB`,value:i.gain.value})),l=r.createContainer(...s,this.mixSliderElement,this.inputSlider,this.outputSlider);e.innerHTML="",e.appendChild(l)}}const Q=[{title:"Church",path:"/impulse_responses/Church Schellingwoude/Church Schellingwoude.wav"},{title:"Factory Hall",path:"/impulse_responses/Factory Hall/Factory Hall/Factory Hall.wav"},{title:"Claustrofobia v1.1",path:"/impulse_responses/Claustrofobia v1.1/Dustbin 3 mono/Dustbin 3.C.wav"}];class z extends _{static NAME="Reverb (IR)";get name(){return z.NAME}convolver;selectedIRPath="";constructor(e){super(e),this.convolver=this.audioContext.createConvolver(),this.input.connect(this.convolver).connect(this.wetNode)}setIRBuffer(e){this.convolver.buffer=e}render(e){const o=A(),r=Q.map(i=>({value:i.path,displayText:i.title})),s=i=>{this.selectedIRPath!==i&&(this.selectedIRPath=i,console.log("(reverb): Loading IR from path:",i),ae(i).then(n=>this.audioContext.decodeAudioData(n)).then(n=>this.setIRBuffer(n)).catch(n=>console.error("Error fetching IR audio buffer:",n)))};this.selectedIRPath||s(Q[0].path);const l=o.createContainer(o.select("Type",s,{options:r,selectedValue:this.selectedIRPath}),this.mixSliderElement);e.innerHTML="",e.appendChild(l)}}class W extends _{static NAME="Delay";get name(){return W.NAME}maxDelayTime=5;delay;feedback;constructor(e){super(e),this.delay=e.createDelay(this.maxDelayTime),this.feedback=e.createGain(),this.delay.delayTime.value=.5,this.feedback.gain.value=.1,this.delay.connect(this.feedback),this.feedback.connect(this.delay),this.input.connect(this.delay),this.delay.connect(this.wetNode)}render(e){const o=A(),r=o.createContainer(o.slider("Feedback",s=>this.feedback.gain.value=s,{min:0,max:this.maxDelayTime,value:this.feedback.gain.value,defaultValue:0,step:.1}),o.slider("Delay",s=>this.delay.delayTime.value=s,{min:0,max:this.maxDelayTime,value:this.delay.delayTime.value,defaultValue:0,step:.1}),this.mixSliderElement,this.inputSlider,this.outputSlider);e.innerHTML="",e.appendChild(r)}}class fe extends _{get name(){return"Compressor"}compressor;blockElement;constructor(e){super(e),this.compressor=e.createDynamicsCompressor(),this.input.connect(this.compressor),this.compressor.connect(this.wetNode);const o=A(),r=E=>`${E.toFixed(1)} dB`,s=E=>`${(E*1e3).toFixed(1)} ms`,i={threshold:{min:-60,max:0,defaultValue:0,format:r,type:"log"},knee:{min:0,max:40,defaultValue:18,format:r,type:"log"},ratio:{min:1,max:20,defaultValue:4,format:E=>E.toFixed(1),type:"linear"},attack:{min:.005,max:.25,defaultValue:.005,speed:.2,format:s,type:"exp"},release:{min:.005,max:.25,defaultValue:.005,speed:.2,format:s,type:"exp"}},n=E=>{let m=ie;return E==="log"?m=se:E==="exp"&&(m=re),m};this.blockElement=o.block(Object.keys(i).map(E=>{const m=E,y=i[m],S=this.compressor[m],w=n(y.type);return o.knob(m.charAt(0).toUpperCase()+m.slice(1),O=>S.setValueAtTime(w(O,y.min,y.max),this.audioContext.currentTime),{defaultValue:.5,value:.5,speed:"speed"in y?y.speed:.5,formatter:O=>y.format?.(w(O,y.min,y.max))})}))}render(e){const o=A(),r=o.createContainer(o.splitterHorizontal(),this.blockElement,o.splitterHorizontal(),this.mixSliderElement,this.inputSlider,this.outputSlider);e.innerHTML="",e.appendChild(r)}}const J=44100,pe={sampleRate:J},t={recording:!1,playback:null,playbackOffsetSeconds:0,selection:{selected:!1,selecting:!1,start:0,end:0},audioContext:new AudioContext(pe),rawAudioBuffer:null,sourceNode:null,currentFile:null},X={PLAY:"Space"},Z=[{id:"reverb",name:"Reverb",getInstance:a=>new z(a)},{id:"equalizer",name:"EQ (7 Band)",getInstance:a=>new Y(a)},{id:"delay",name:"Delay",getInstance:a=>new W(a)},{id:"compressor",name:"Compressor",getInstance:a=>new fe(a)}];window.addEventListener("load",async()=>{const a=document.getElementById("load-sample"),e=document.getElementById("sample-file-input"),o=document.getElementById("loop-playback"),r=document.getElementById("record"),s=document.getElementById("play"),l=document.getElementById("add-plugin-select"),i=document.querySelector("canvas"),n=i.getContext("2d"),E=ue({audioContext:t.audioContext,onUpdate:d=>console.log("Audio Graph Updated!",d)});(()=>{for(const d of Z){const f=document.createElement("option");f.value=d.id,f.innerText=d.name,l.add(f)}l.addEventListener("change",d=>{const f=Z.find(b=>b.id===d.target?.value);f&&(console.log("Adding plugin:",f),E.addPlugin(f.getInstance(t.audioContext)),l.value="")})})();let m=0,y=0,S=1,w=null;const O=d=>{if(!t.rawAudioBuffer)return 0;const b=(d-y)/(i.width*S)*t.rawAudioBuffer.length;return Math.round(b)},I=()=>{s.innerText=(t.playback?"Pause":"Play")+` (${X.PLAY})`},c=d=>{if(!t.sourceNode)return 0;let f=t.playbackOffsetSeconds+d;if(t.sourceNode.loop)if(t.selection.selected){const b=t.sourceNode.loopEnd-t.sourceNode.loopStart,N=(f-t.sourceNode.loopStart)%b+b%b;f=t.sourceNode.loopStart+N}else f%=t.rawAudioBuffer.duration;return f},g=()=>{if(!t.playback)return!1;if(t.sourceNode){const d=t.audioContext.currentTime-t.playback.startedTime;t.playbackOffsetSeconds=c(d),t.sourceNode.onended=null,t.sourceNode.stop(),t.sourceNode.disconnect(),t.sourceNode=null,console.log("Pause! Played seconds: (%f sec, offset = %f sec)",d,t.playbackOffsetSeconds,t.rawAudioBuffer.duration)}t.playback=null,I()},u=()=>{if(t.playback)return;if(!t.rawAudioBuffer){console.log("Cannot play audio without audio buffer",t);return}const{length:d,duration:f}=t.rawAudioBuffer,b=t.selection.start/d*f,N=t.selection.end/d*f;t.sourceNode=t.audioContext.createBufferSource(),t.sourceNode.buffer=t.rawAudioBuffer,t.sourceNode.loop=o.checked,t.sourceNode.playbackRate.value=1,t.sourceNode.loopStart=Math.min(b,N),t.sourceNode.loopEnd=Math.max(b,N),E.apply(t.sourceNode,t.audioContext.destination),t.sourceNode.onended=k=>{t.playback&&(console.log("Playback ended event",{event:k,state:t}),t.playback=null,t.playbackOffsetSeconds=t.selection.selected?Math.min(b,N):0,t.sourceNode?.stop(),t.sourceNode?.disconnect(),t.sourceNode=null,I())};let v=0;if(t.selection.selected){const k=t.sourceNode.loop?t.sourceNode.loopStart:t.playbackOffsetSeconds;v=t.sourceNode.loopEnd-k}t.sourceNode.start(0,t.playbackOffsetSeconds,t.selection.selected&&!t.sourceNode.loop?v:void 0),t.playback={startedTime:t.audioContext.currentTime},I()},p=d=>{g(),S=1,y=0,m=0,t.rawAudioBuffer=d,w=null},h=()=>{const d=document.createElement("canvas");d.width=i.width,d.height=i.height;const f=d.getContext("2d");if(!t.rawAudioBuffer)return d;const b=t.rawAudioBuffer.getChannelData(0),N=i.width*S,v=b.length,k=Math.ceil(v/N);f.beginPath();const L=i.height/2;for(let R=0;R<i.width;R++){const $=Math.floor((R-y)/N*v),ee=Math.min(v,$+k);let F=1,G=-1;for(let H=$;H<ee&&H<b.length;H++){const B=b[H];B>G&&(G=B),B<F&&(F=B)}f.moveTo(R,(1+F)*L),f.lineTo(R,(1+G)*L)}return f.closePath(),f.strokeStyle="rgba(126, 36, 128, 1)",f.stroke(),d};let T=0;const C=d=>{if(!T)return T=d,requestAnimationFrame(C);const f=(d-T)/1e3;if(T=d,!t.rawAudioBuffer)return requestAnimationFrame(C);const b=t.rawAudioBuffer;n.clearRect(0,0,i.width,i.height),w??=h(),n.drawImage(w,0,0);const N=i.width*S;if(n.beginPath(),n.moveTo(m,0),n.lineTo(m,i.height),n.closePath(),n.strokeStyle="#6d6d6d44",n.stroke(),t.selection.selecting||t.selection.selected){const v=t.selection.start/b.length*N+y,k=t.selection.end/b.length*N+y;n.fillStyle="rgba(67, 140, 235, 0.5)",n.fillRect(v,0,k-v,i.height),n.beginPath(),n.moveTo(v,0),n.lineTo(v,i.height),n.closePath(),n.lineWidth=2,n.strokeStyle="rgba(67, 140, 235, 1)",n.stroke(),n.beginPath(),n.moveTo(k,0),n.lineTo(k,i.height),n.closePath(),n.lineWidth=2,n.strokeStyle="rgba(67, 140, 235, 1)",n.stroke()}if(t.playback&&t.sourceNode){const v=t.audioContext.currentTime-t.playback.startedTime,L=c(v)*N/t.rawAudioBuffer.duration+y;n.beginPath(),n.moveTo(L,0),n.lineTo(L,i.height),n.closePath(),n.strokeStyle="#ffffffff",n.lineWidth=2,n.stroke()}else if(t.playbackOffsetSeconds>0){const v=t.playbackOffsetSeconds*N/t.rawAudioBuffer.duration+y;n.beginPath(),n.moveTo(v,0),n.lineTo(v,i.height),n.closePath(),n.strokeStyle="#ffffffff",n.lineWidth=2,n.stroke()}if(n.font="14px Monospace",n.fillStyle="rgba(46, 204, 6, 1)",n.fillText("FPS: "+(1/f).toFixed(0),14,24),t.currentFile){const v=`File ${t.currentFile.name} | ${(t.currentFile.size/1024/1024).toFixed(2)} MB`,k=n.measureText(v);n.fillStyle="rgba(255, 255, 255, 1)",n.fillText(v,i.width-k.width-10,24)}requestAnimationFrame(C)};requestAnimationFrame(C);const P=()=>{const d={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,channelCount:1,sampleRate:J}};let f=null;return async()=>{if(t.recording)f&&(f.stop(),f=null),t.recording=!1;else{const b=await navigator.mediaDevices.getUserMedia(d).catch(console.error);if(!b)return;let N=[];f=new MediaRecorder(b,{mimeType:"audio/webm"}),f.ondataavailable=v=>{console.log("New recorded data of size:",v.data.size),N.push(v.data)},f.onstop=()=>{const v=new Blob(N,{type:"audio/webm"});N=[],v.arrayBuffer().then(k=>t.audioContext.decodeAudioData(k)).then(k=>p(k)).catch(k=>console.error("Unable to get an array buffer from MediaRecorder:",k))},f.start(),t.recording=!0}r.innerText=t.recording?"Stop":"Record"}};r.onclick=P(),a.addEventListener("click",()=>e.click()),e.addEventListener("change",()=>{const[d]=e.files||[];if(!d)return;const f=te(d);if(!f.ok){console.error(f.message,d);return}const b=new FileReader;b.onload=()=>{b.result instanceof ArrayBuffer&&t.audioContext.decodeAudioData(b.result).then(p).then(()=>t.currentFile=d).catch(N=>console.error("Error during decoding an audio file:",N))},b.onerror=N=>{console.error("File reading error",N)},b.onprogress=N=>{console.log("File reading progress:",N)},b.readAsArrayBuffer(d)});const D=()=>{t.playback?g():u(),s.innerText=(t.playback?"Pause":"Play")+` (${X.PLAY})`};s.addEventListener("click",D),window.addEventListener("keydown",d=>{if(d.code===X.PLAY)return d.preventDefault(),D()}),i.addEventListener("mousemove",d=>{m=d.offsetX,t.rawAudioBuffer&&t.selection.selecting&&(t.selection.end=O(d.offsetX))}),i.addEventListener("mousedown",d=>{if(t.rawAudioBuffer){t.selection.selecting=!0;const f=O(d.offsetX);t.selection.start=f,t.selection.end=f}}),window.addEventListener("mouseup",d=>{const b=d.target&&d.target instanceof HTMLCanvasElement?d.offsetX:m;if(t.rawAudioBuffer&&t.selection.selecting){t.selection.end=O(b),t.selection.selecting=!1,t.selection.selected=t.selection.start!==t.selection.end,console.log("Selection event on mouseup:",t.selection);const N=Math.max(0,Math.min(t.selection.start,t.selection.end)/t.rawAudioBuffer.length*t.rawAudioBuffer.duration);t.playback?(g(),t.playbackOffsetSeconds=N,u()):t.playbackOffsetSeconds=N}}),i.addEventListener("wheel",d=>{if(d.preventDefault(),!t.rawAudioBuffer)return!1;const f=d.ctrlKey?.5:.1,b=1-Math.sign(d.deltaY)*f,N=Math.max(1,S*b),v=i.width*N-i.width,k=(m-y)/(i.width*S);y=Math.max(-v,Math.min(0,m-k*i.width*N)),w=null,S=N});const M=()=>{i.width=document.body.clientWidth-20,i.height=200,w=null};window.addEventListener("resize",M),M()});
