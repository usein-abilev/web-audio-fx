(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))c(l);new MutationObserver(l=>{for(const r of l)if(r.type==="childList")for(const y of r.addedNodes)y.tagName==="LINK"&&y.rel==="modulepreload"&&c(y)}).observe(document,{childList:!0,subtree:!0});function n(l){const r={};return l.integrity&&(r.integrity=l.integrity),l.referrerPolicy&&(r.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?r.credentials="include":l.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function c(l){if(l.ep)return;l.ep=!0;const r=n(l);fetch(l.href,r)}})();const ee=["audio/mpeg","audio/ogg","audio/wave","audio/wav","audio/x-wav","audio/mp4","audio/flac"],te=8*1024*1024,re=a=>a?ee.includes(a.type)?a.size>te?{ok:!1,message:"File size has exceeded the MAX_AUDIO_FILE_SIZE constraint: "+te}:{ok:!0}:{ok:!1,message:"Unsupported file type. Supported MIME-types: "+ee}:{ok:!1,message:"File not found"},ce={BASE_URL:"/web-audio-fx/"},ie=a=>20*Math.log10(a),le=a=>10**(a/20),de=(a,e,n)=>e+(n-e)*a,ue=(a,e,n)=>e+(n-e)*a**2.5,pe=(a,e,n)=>e*(n/e)**a,ne=(a,e,n,c)=>Math.sqrt((n-a)**2+(c-e)**2),fe=a=>{const{BASE_URL:e}=ce,n=e.endsWith("/")?e:e+"/",c=a.startsWith("/")?a.substring(1):a;return n+c},he=a=>{const e=Math.floor(a/60),n=Math.floor(a%60);return`${e.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`},q=()=>{const a=Date.now().toString(16),e=Math.floor(Math.random()*2**52).toString(16);return`${a}-${e}`},me=async a=>{try{return await(await fetch(a)).arrayBuffer()}catch(e){throw console.error("Error fetching audio array buffer:",e),new Error("Error fetching audio data")}},V=(a,e)=>{try{return a.disconnect(e),!0}catch{return!1}},ge=80,z=1024*4,ye=a=>Math.sqrt(a.reduce((e,n)=>e+n*n,0)/a.length),be=a=>{const e=document.getElementById("audio-volume-meter"),n=e.getContext("2d"),c=a.createAnalyser();c.fftSize=z;const l=a.createAnalyser();l.fftSize=z;const r=new Float32Array(z),y=new Float32Array(z),u=60,s=2,o=(T,E)=>{const k=ye(T),A=ie(k),i=-20,p=-6,m=(Math.min(i,A)+u)/u,g=(Math.min(p,A)+u)/u,h=(Math.min(0,A)+u)/u,I=e.height-m*e.height,O=e.height-g*e.height,B=e.height-h*e.height,M=e.width/2+s*(E*2-1);n.fillStyle="#ff0000",n.fillRect(E*M,B,e.width/2,e.height),n.fillStyle="#ffbb4a",n.fillRect(E*M,O,e.width/2,e.height),n.fillStyle="#50bb4a",n.fillRect(E*M,I,e.width/2,e.height)},v=()=>{requestAnimationFrame(v),c.getFloatTimeDomainData(r),l.getFloatTimeDomainData(y),n.clearRect(0,0,e.width,e.height),o(r,0),o(y,1);const T=e.height/(u/5);for(let E=0;E<=u/5;E++){const k=E*T;n.fillStyle="#fefefe",n.font="9px Consolas",n.fillText(`${E*5}`,1,k-2),n.fillStyle="#888",n.fillRect(0,k,10,1)}};return v(),{connect(T){const E=a.createChannelSplitter(2);E.connect(c,0),E.connect(l,1),T.connect(E)},resize(T,E){e.width=T,e.height=E},getWidth:()=>ge}},C={createContainer(...a){const e=document.createElement("div");return e.className="plugin-container",a.forEach(n=>e.appendChild(n)),e},block(a){const e=document.createElement("div");return e.className="flex-block",e.append(...a),e},splitterHorizontal(){const a=document.createElement("div");return a.className="horizontal-splitter",a},slider(a,e,n={defaultValue:0,value:0}){const c=document.createElement("div"),l=document.createElement("input"),r=document.createElement("label"),y=document.createElement("label"),u=n.value??n.defaultValue??0;return typeof n.formatter=="function"?y.append(n.formatter(u)):y.innerText=u.toFixed(1),c.className="band",l.type="range",l.value=String(u),console.log("Set input value for '%s'",a,l.value,n.value),r.append(a),c.append(l,y,r),Object.assign(l,n),l.addEventListener("input",s=>{const o=+s.target.value;e(o,s),y.innerHTML="",typeof n.formatter=="function"?y.append(n.formatter(o)):y.innerText=o.toFixed(1)}),c.addEventListener("dblclick",()=>{l.value=String(n.defaultValue??0),l.dispatchEvent(new Event("input"))}),c},select(a,e,n){const c=document.createElement("div");c.className="select-block";const l=document.createElement("span"),r=document.createElement("select");r.name="plugin-select",r.value=n.selectedValue||"";const y=n.options.map(({value:u,displayText:s})=>{const o=document.createElement("option");return o.value=u,o.innerText=s,n.selectedValue===u&&o.setAttribute("selected","true"),o});return r.addEventListener("change",u=>{e(u.target.value,u)}),l.append(a),r.append(...y),c.append(l,r),c},checkbox(a,e,n){const c=document.createElement("label"),l=document.createElement("input");return l.type="checkbox",l.checked=!!n.defaultValue,l.addEventListener("change",r=>{e(r.target.checked,r)}),c.append(a,l),c},knob(a,e,n){const c=document.createElement("div");c.className="knob-container";const l=document.createElement("div");l.className="label",l.append(a);const r=document.createElement("div"),y=document.createElement("div"),u=document.createElement("div");r.className="knob",y.className="arc",u.className="indicator",r.append(y,u);const s=document.createElement("div");s.className="value";const o=(n.max??1)*100;let v=n.value*100,T=!1,E=0;const k=()=>{const i=v*270/o-135;y.style.setProperty("--angle",`${270/o*v}deg`),u.style.transform=`translateX(-50%) rotate(${i}deg)`,s.textContent=n.formatter?.(v/100)||String(v)},A=(i,p)=>{v=i,v=Math.max(n.min||0,Math.min(o,v)),e(v/100,p),k()};return r.addEventListener("mousedown",i=>{T=!0,E=i.clientY}),r.addEventListener("dblclick",i=>{A(n.defaultValue*100,i)}),r.addEventListener("wheel",i=>{const p=-1*Math.sign(i.deltaY);v+=p*2,A(v,i)}),document.addEventListener("mouseup",()=>T=!1),document.addEventListener("mousemove",i=>{if(!T)return;const p=E-i.clientY;E=i.clientY,v+=p*(n.speed||.5),A(v,i)}),k(),c.append(l,r,s),c}};class j{constructor(e){this.audioContext=e,this.input=this.audioContext.createGain(),this.output=this.audioContext.createGain();const n=le(0),c={min:0,max:2,defaultValue:n,value:n,speed:.3,formatter:r=>`${ie(r).toFixed(1)} dB`},l=(r,y)=>{r.gain.setValueAtTime(y,this.audioContext.currentTime)};this.inputSlider=C.knob("Input Gain",r=>l(this.input,r),c),this.outputSlider=C.knob("Output Gain",r=>l(this.output,r),c)}input;output;inputSlider;outputSlider;get name(){return"Audio Graph Node"}get[Symbol.toStringTag](){return"AudioGraphNode"}}class X extends j{bypass=!1;dryNode;wetNode;mixValue=1;mixSliderElement;constructor(e){super(e),this.dryNode=this.audioContext.createGain(),this.wetNode=this.audioContext.createGain(),this.setMixValue(1),this.setBypass(!1),this.mixSliderElement=C.knob("Mix",n=>this.setMixValue(n),{max:1,value:this.getMixValue(),defaultValue:1})}setBypass(e){this.bypass=e,this.bypass?(V(this.wetNode,this.output),V(this.dryNode,this.output),V(this.input,this.dryNode),this.input.connect(this.output)):(V(this.input,this.output),this.input.connect(this.dryNode),this.dryNode.connect(this.output),this.wetNode.connect(this.output))}getMixValue(){return this.mixValue}setMixValue(e){this.mixValue=e,this.dryNode.gain.value=1-this.mixValue,this.wetNode.gain.value=this.mixValue}render(e){e.innerHTML=""}get name(){return"Unknown Audio Plugin"}get[Symbol.toStringTag](){return"Audio Plugin"}}class Ee extends j{mono=!1;channelMerger;stereoPanner;panKnob;get name(){return"Input Node"}constructor(e){super(e),this.channelMerger=e.createChannelMerger(),this.stereoPanner=e.createStereoPanner(),this.input.connect(this.stereoPanner),this.stereoPanner.connect(this.output),this.panKnob=C.knob("Pan",n=>{this.stereoPanner.pan.setValueAtTime(n*2-1,this.audioContext.currentTime),console.log("stereo panner:",this.stereoPanner.pan.value,n)},{max:1,defaultValue:.5,value:(this.stereoPanner.pan.value+1)/2,formatter:n=>{let c="C";return n<.5?c="L":n>.5&&(c="R"),`${Math.abs(n*200-100).toFixed(0)} ${c}`}})}setMono(e){this.mono=e,e?(this.input.disconnect(this.stereoPanner),this.input.connect(this.channelMerger,0,0),this.input.connect(this.channelMerger,0,1),this.channelMerger.connect(this.stereoPanner)):(this.input.disconnect(this.channelMerger),this.channelMerger.disconnect(),this.input.connect(this.stereoPanner))}render(e){e.innerHTML="";const n=C.createContainer(C.checkbox("Mono: ",c=>this.setMono(c),{defaultValue:this.mono}),this.panKnob,this.inputSlider,this.outputSlider);e.append(n)}}class Ne extends j{constructor(e){super(e),this.input.connect(this.output)}get name(){return"Output Node"}render(e){e.innerHTML="";const n=C.createContainer(this.inputSlider,this.outputSlider);e.append(n)}}const xe=(a,e,n)=>{const c=document.getElementById("context-menu"),l=document.createElement("ul");c.innerHTML="",c.append(l),a.addEventListener("mousedown",()=>{c.style.display="none"}),a.addEventListener("contextmenu",r=>{r.preventDefault();const{clientX:y,clientY:u}=r;if(!e(r))return;const s=n.map(o=>{if(!o.canShow?.())return;const v=document.createElement("li");return v.dataset.action=o.key,v.innerText=typeof o.displayText=="string"?o.displayText:o.displayText(),v.addEventListener("click",T=>{T.preventDefault(),o.handler(T),c.style.display="none"}),v}).filter((o=>o));s.length&&(l.innerHTML="",l.append(...s),c.style.display="block",c.style.left=`${y}px`,c.style.top=`${u}px`)})},S={NODE_WIDTH:150,NODE_HEIGHT:50,CONNECTOR_GAP:15,CONNECTOR_RADIUS:5,CONNNECTOR_RADIUS_HOVERED:10},ve=a=>{const e={nodes:[{type:"input",id:q(),instance:new Ee(a.audioContext),position:{x:0,y:0},connections:{}},{type:"output",id:q(),instance:new Ne(a.audioContext),position:{x:0,y:0},connections:{}}]},[n,c]=e.nodes,l=(i,p)=>{if(console.log("Creating new connection between",i,p),i.connections[p.id])return i.instance.output.disconnect(p.instance.input),delete i.connections[p.id],a.onUpdate(e),!0;const m=[p.id],g=new Set;for(;m.length;){const h=m.pop();if(h){if(h===i.id)return console.warn("The connection between nodes (%s -> %s) will cause a circular dependency",i.id,p.id),!1;if(!g.has(h)){g.add(h);const I=e.nodes.find(O=>O.id===h);m.push(...Object.keys(I.connections));continue}}}return i.connections[p.id]=1,i.instance.output.connect(p.instance.input),a.onUpdate(e),!0};l(n,c);const r={isConnector:!1,isInput:!1,nodeId:""},y=document.getElementById("audio-plugin"),u=document.getElementById("graph"),s=u.getContext("2d");xe(u,()=>!!e.selectedNode,[{key:"bypass",displayText:()=>e.selectedNode?.type==="plugin"?e.selectedNode.instance.bypass?"Activate node":"Bypass node":"",canShow:()=>e.selectedNode?.type==="plugin",handler:()=>{if(!e.selectedNode)return;const i=e.selectedNode.instance;i.setBypass(!i.bypass)}},{key:"delete",displayText:"Delete node",canShow:()=>e.selectedNode?.type==="plugin",handler:()=>{if(!e.selectedNode||e.selectedNode.type!=="plugin")return;console.log("Deleting:",e.selectedNode,e.nodes);const i=new Map;let p=-1;e.nodes.forEach((m,g)=>{if(i.set(m.id,m),m.id===e.selectedNode.id){p=g;return}if(e.selectedNode.id in m.connections){try{m.instance.output.disconnect(e.selectedNode.instance.input)}catch{}delete m.connections[e.selectedNode.id]}});for(const m in e.selectedNode.connections){const g=i.get(m);if(g)try{e.selectedNode.instance.output.disconnect(g.instance.input)}catch{}}delete e.selectedNode,e.nodes.splice(p,1),y.innerHTML=""}}]);const o=()=>{requestAnimationFrame(o),s.clearRect(0,0,u.width,u.height);for(const i of e.nodes){const p=e.selectedNode?.id===i.id;s.save(),s.globalAlpha=i.type==="plugin"&&i.instance.bypass?.5:1,s.beginPath(),s.fillStyle="transparent",s.strokeStyle=p?"steelblue":"#555",s.roundRect(i.position.x,i.position.y,S.NODE_WIDTH,S.NODE_HEIGHT,5),s.closePath(),s.stroke(),s.fill(),s.fillStyle="#FFFFFF",s.font="14px Arial";const m=i.instance.name;s.fillText(m,i.position.x+10,i.position.y+25),s.restore();const g=r.isConnector&&r.nodeId===i.id;if(i.type!=="input"){const h=g&&r.isInput?S.CONNNECTOR_RADIUS_HOVERED:S.CONNECTOR_RADIUS;s.fillStyle="#555555",s.beginPath(),s.arc(i.position.x-S.CONNECTOR_GAP,i.position.y+S.NODE_HEIGHT/2,h,0,Math.PI*2),s.fill()}if(i.type!=="output"){const h=g&&!r.isInput?S.CONNNECTOR_RADIUS_HOVERED:S.CONNECTOR_RADIUS;s.fillStyle="#555555",s.beginPath(),s.arc(i.position.x+S.NODE_WIDTH+S.CONNECTOR_GAP,i.position.y+S.NODE_HEIGHT/2,h,0,Math.PI*2),s.fill()}for(const h in i.connections){const I=e.nodes.find(O=>O.id===h);if(I){const O=i.position.x+S.NODE_WIDTH+S.CONNECTOR_GAP,B=i.position.y+S.NODE_HEIGHT/2,M=I.position.x-S.CONNECTOR_GAP,R=I.position.y+S.NODE_HEIGHT/2,U=O+S.NODE_HEIGHT,L=B,H=M-S.NODE_HEIGHT,d=R;s.strokeStyle="#888888",s.beginPath(),s.moveTo(O,B),s.bezierCurveTo(U,L,H,d,M,R),s.stroke()}}}if(e.linking){const{NODE_WIDTH:i,NODE_HEIGHT:p,CONNECTOR_GAP:m}=S,g=e.nodes.find(O=>O.id===e.linking.nodeSourceId),h=e.linking.isSourceInput?g.position.x-m:g.position.x+i+m,I=g.position.y+p/2;s.strokeStyle="steelblue",s.beginPath(),s.moveTo(h,I),s.lineTo(e.linking.mouseX,e.linking.mouseY),s.stroke()}};o();const v=(i,p)=>{for(const m of e.nodes){const{x:g,y:h}=m.position;if(g<=i&&g+S.NODE_WIDTH>=i&&h<=p&&h+S.NODE_HEIGHT>=p)return m}return null},T=(i,p)=>{const m=S.CONNNECTOR_RADIUS_HOVERED;for(const g of e.nodes){const{x:h,y:I}=g.position;if(g.type!=="input"&&ne(i,p,h-S.CONNECTOR_GAP,I+S.NODE_HEIGHT/2)<=m)return{node:g,input:!0};if(g.type!=="output"&&ne(i,p,h+S.NODE_WIDTH+S.CONNECTOR_GAP,I+S.NODE_HEIGHT/2)<=m)return{node:g,input:!1}}return null},E=i=>{i.instance.render(y)},k=i=>{u.style.cursor=i};u.addEventListener("mousedown",i=>{const{offsetX:p,offsetY:m}=i,g=T(p,m);if(g){e.linking={nodeSourceId:g.node.id,isSourceInput:g.input,mouseX:p,mouseY:m},k("grabbing");return}const h=v(p,m);if(h){k("grabbing"),e.selectedNode?.id!==h.id&&E(h),e.selectedNode=h,e.draggingAnchor={x:p-h.position.x,y:m-h.position.y};return}delete e.selectedNode,y.innerHTML=""}),u.addEventListener("mousemove",i=>{const{offsetX:p,offsetY:m}=i,g=T(p,m);if(g)r.nodeId=g.node.id,r.isInput=g.input,r.isConnector=!0,u.style.cursor="pointer";else{r.isConnector=!1;const h=v(p,m);h?(u.style.cursor="pointer",r.nodeId=h.id):(u.style.cursor="default",r.nodeId="")}e.linking&&(e.linking.mouseX=p,e.linking.mouseY=m,k("grabbing")),e.draggingAnchor&&e.selectedNode&&(e.selectedNode.position.x=p-e.draggingAnchor.x,e.selectedNode.position.y=m-e.draggingAnchor.y)}),u.addEventListener("mouseup",i=>{const{offsetX:p,offsetY:m}=i;if(e.draggingAnchor&&e.selectedNode&&(k("default"),delete e.draggingAnchor),e.linking){const g=T(p,m),h=e.nodes.find(O=>O.id===e.linking.nodeSourceId),{isSourceInput:I}=e.linking;g&&h&&g.input!==e.linking.isSourceInput&&(I?l(g.node,h):l(h,g.node)),delete e.linking}});const A=()=>{u.width=document.body.clientWidth-20,u.height=350,n.position.x=50,n.position.y=u.height/2,c.position.x=u.width-200,c.position.y=u.height/2};return A(),window.addEventListener("resize",A),{apply(i,p){c.instance.output.disconnect(),c.instance.output.connect(p),i.connect(n.instance.input)},analyze(i){i(c.instance.output)},addPlugin(i){const p={id:q(),type:"plugin",position:{x:u.width/2,y:u.height/2},instance:i,connections:{}};return e.nodes.push(p),!0}}};class Z extends X{static NAME="Equalizer (7 Band)";get name(){return Z.NAME}bands;blockElement;constructor(e){super(e),this.bands=[80,250,500,1500,3e3,5e3,8e3].map((c,l)=>{const r=this.audioContext.createBiquadFilter();return l===0?r.type="lowshelf":l===6?r.type="highshelf":r.type="peaking",r.frequency.value=c,r.Q.value=1,r}),this.bands.reduce((c,l)=>(c.connect(l),l)),this.input.connect(this.bands[0]),this.bands.at(-1)?.connect(this.wetNode);const n={min:-12,max:12,step:.1,defaultValue:0};this.blockElement=C.block(this.bands.map(c=>C.slider(`${c.frequency.value}Hz`,l=>c.gain.setValueAtTime(l,this.audioContext.currentTime+.01),{...n,formatter:l=>`${l.toFixed(1)} dB`,value:c.gain.value})))}render(e){const n=C.createContainer(this.blockElement,this.mixSliderElement,this.inputSlider,this.outputSlider);e.innerHTML="",e.appendChild(n)}}const oe=[{title:"Church",path:"/impulse_responses/Church Schellingwoude/Church Schellingwoude.wav"},{title:"Factory Hall",path:"/impulse_responses/Factory Hall/Factory Hall/Factory Hall.wav"},{title:"Claustrofobia v1.1",path:"/impulse_responses/Claustrofobia v1.1/Dustbin 3 mono/Dustbin 3.C.wav"}].map(a=>({...a,path:fe(a.path)}));class Q extends X{static NAME="Reverb (IR)";get name(){return Q.NAME}convolver;selectedIRPath="";constructor(e){super(e),this.convolver=this.audioContext.createConvolver(),this.input.connect(this.convolver).connect(this.wetNode)}setIRBuffer(e){this.convolver.buffer=e}render(e){const n=oe.map(r=>({value:r.path,displayText:r.title})),c=r=>{this.selectedIRPath!==r&&(this.selectedIRPath=r,console.log("(reverb): Loading IR from path:",r),me(r).then(y=>this.audioContext.decodeAudioData(y)).then(y=>this.setIRBuffer(y)).catch(y=>console.error("Error fetching IR audio buffer:",y)))};this.selectedIRPath||c(oe[0].path);const l=C.createContainer(C.select("Type",c,{options:n,selectedValue:this.selectedIRPath}),this.mixSliderElement);e.innerHTML="",e.appendChild(l)}}class J extends X{static NAME="Delay";get name(){return J.NAME}maxDelayTime=5;delay;feedback;constructor(e){super(e),this.delay=e.createDelay(this.maxDelayTime),this.feedback=e.createGain(),this.delay.delayTime.value=.5,this.feedback.gain.value=.2,this.delay.connect(this.feedback),this.feedback.connect(this.delay),this.input.connect(this.delay),this.delay.connect(this.wetNode)}render(e){const n=C.createContainer(C.slider("Feedback",c=>this.feedback.gain.value=c,{min:0,max:2,value:this.feedback.gain.value,defaultValue:.2,step:.01,formatter:c=>`${(c*100).toFixed(0)}%`}),C.slider("Delay",c=>this.delay.delayTime.value=c,{min:0,max:this.maxDelayTime,value:this.delay.delayTime.value,defaultValue:.5,step:.1,formatter:c=>`${c.toFixed(1)} sec`}),this.mixSliderElement,this.inputSlider,this.outputSlider);e.innerHTML="",e.appendChild(n)}}class Se extends X{get name(){return"Compressor"}compressor;blockElement;constructor(e){super(e),this.compressor=e.createDynamicsCompressor(),this.input.connect(this.compressor),this.compressor.connect(this.wetNode);const n=u=>`${u.toFixed(1)} dB`,c=u=>`${(u*1e3).toFixed(1)} ms`,r={threshold:{min:-60,max:0,defaultValue:0,format:n,type:"log"},knee:{min:0,max:40,defaultValue:18,format:n,type:"log"},ratio:{min:1,max:20,defaultValue:4,format:u=>u.toFixed(1),type:"linear"},attack:{min:.005,max:.25,defaultValue:.005,speed:.2,format:c,type:"exp"},release:{min:.005,max:.25,defaultValue:.005,speed:.2,format:c,type:"exp"}},y=u=>{let s=de;return u==="log"?s=ue:u==="exp"&&(s=pe),s};this.blockElement=C.block(Object.keys(r).map(u=>{const s=u,o=r[s],v=this.compressor[s],T=y(o.type);return C.knob(s.charAt(0).toUpperCase()+s.slice(1),E=>v.setValueAtTime(T(E,o.min,o.max),this.audioContext.currentTime),{defaultValue:.5,value:.5,speed:"speed"in o?o.speed:.5,formatter:E=>o.format?.(T(E,o.min,o.max))})}))}render(e){const n=C.createContainer(C.splitterHorizontal(),this.blockElement,C.splitterHorizontal(),this.mixSliderElement,this.inputSlider,this.outputSlider);e.innerHTML="",e.appendChild(n)}}const ae=44100,Te={sampleRate:ae},t={recording:!1,playback:null,playbackOffsetSeconds:0,selection:{selected:!1,selecting:!1,start:0,end:0},audioContext:new AudioContext(Te),rawAudioBuffer:null,sourceNode:null,currentFile:null},K={PLAY:"Space"},se=[{id:"reverb",name:"Reverb",getInstance:a=>new Q(a)},{id:"equalizer",name:"EQ (7 Band)",getInstance:a=>new Z(a)},{id:"delay",name:"Delay",getInstance:a=>new J(a)},{id:"compressor",name:"Compressor",getInstance:a=>new Se(a)}],ke=()=>(t.playback?t.audioContext.currentTime-t.playback.startedTime:0)+t.playbackOffsetSeconds;window.addEventListener("load",async()=>{const a=document.getElementById("load-sample"),e=document.getElementById("sample-file-input"),n=document.getElementById("loop-playback"),c=document.getElementById("record"),l=document.getElementById("play"),r=document.getElementById("reverse-sample"),y=document.getElementById("add-plugin-select"),u=document.getElementById("init-placeholder"),s=document.querySelector("canvas#audio-sample"),o=s.getContext("2d"),v=be(t.audioContext),T=ve({audioContext:t.audioContext,onUpdate:d=>console.log("Audio Graph Updated!",d)});(()=>{for(const d of se){const f=document.createElement("option");f.value=d.id,f.innerText=d.name,y.add(f)}y.addEventListener("change",d=>{const f=se.find(b=>b.id===d.target?.value);f&&(console.log("Adding plugin:",f),T.addPlugin(f.getInstance(t.audioContext)),y.value="")})})();let E=0,k=0,A=1,i=null;const p=d=>{if(!t.rawAudioBuffer)return 0;const b=(d-k)/(s.width*A)*t.rawAudioBuffer.length;return Math.round(b)},m=()=>{l.innerText=(t.playback?"Pause":"Play")+` (${K.PLAY})`},g=d=>{if(!t.sourceNode)return 0;let f=t.playbackOffsetSeconds+d;if(t.sourceNode.loop)if(t.selection.selected){const b=t.sourceNode.loopEnd-t.sourceNode.loopStart,N=(f-t.sourceNode.loopStart)%b+b%b;f=t.sourceNode.loopStart+N}else f%=t.rawAudioBuffer.duration;return Math.max(0,f)},h=()=>{if(!t.playback)return!1;if(t.sourceNode){const d=t.audioContext.currentTime-t.playback.startedTime;t.playbackOffsetSeconds=g(d),t.sourceNode.onended=null,t.sourceNode.stop(),t.sourceNode.disconnect(),t.sourceNode=null,console.log("Pause! Played seconds: (%f sec, offset = %f sec)",d,t.playbackOffsetSeconds,t.rawAudioBuffer.duration)}t.playback=null,m()},I=()=>{if(t.playback)return;if(!t.rawAudioBuffer){console.log("Cannot play audio without audio buffer",t);return}const{length:d,duration:f}=t.rawAudioBuffer,b=t.selection.start/d*f,N=t.selection.end/d*f;t.sourceNode=t.audioContext.createBufferSource(),t.sourceNode.buffer=t.rawAudioBuffer,t.sourceNode.loop=n.checked,t.sourceNode.playbackRate.value=1,t.sourceNode.loopStart=Math.min(b,N),t.sourceNode.loopEnd=Math.max(b,N),T.apply(t.sourceNode,t.audioContext.destination),T.analyze(v.connect),t.sourceNode.onended=w=>{t.playback&&(console.log("Playback ended event",{event:w,state:t}),t.playback=null,t.playbackOffsetSeconds=t.selection.selected?Math.min(b,N):0,t.sourceNode?.stop(),t.sourceNode?.disconnect(),t.sourceNode=null,m())};let x=0;if(t.selection.selected){const w=t.sourceNode.loop?t.sourceNode.loopStart:t.playbackOffsetSeconds;x=Math.max(0,t.sourceNode.loopEnd-w)}t.sourceNode.start(0,t.playbackOffsetSeconds,t.selection.selected&&!t.sourceNode.loop?x:void 0),t.playback={startedTime:t.audioContext.currentTime},m()},O=d=>{u.style.display="none",h(),A=1,k=0,E=0,t.rawAudioBuffer=d,i=null},B=()=>{const d=document.createElement("canvas");d.width=s.width,d.height=s.height;const f=d.getContext("2d");if(!t.rawAudioBuffer)return d;const b=t.rawAudioBuffer.getChannelData(0),N=s.width*A,x=b.length,w=Math.ceil(x/N);f.beginPath();const P=s.height/2;for(let D=0;D<s.width;D++){const _=Math.floor((D-k)/N*x),Y=Math.min(x,_+w);let W=1,$=-1;for(let F=_;F<Y&&F<b.length;F++){const G=b[F];G>$&&($=G),G<W&&(W=G)}f.moveTo(D,(1+W)*P),f.lineTo(D,(1+$)*P)}return f.closePath(),f.strokeStyle="rgba(126, 36, 128, 1)",f.stroke(),d};let M=0;const R=d=>{if(requestAnimationFrame(R),!M||!t.rawAudioBuffer){M=d;return}const f=(d-M)/1e3;M=d;const b=t.rawAudioBuffer;o.clearRect(0,0,s.width,s.height),i??=B(),o.drawImage(i,0,0);const N=s.width*A;if(o.beginPath(),o.moveTo(E,0),o.lineTo(E,s.height),o.closePath(),o.strokeStyle="#6d6d6d44",o.stroke(),t.selection.selecting||t.selection.selected){const x=t.selection.start/b.length*N+k,w=t.selection.end/b.length*N+k;o.fillStyle="rgba(67, 140, 235, 0.5)",o.fillRect(x,0,w-x,s.height),o.beginPath(),o.moveTo(x,0),o.lineTo(x,s.height),o.closePath(),o.lineWidth=2,o.strokeStyle="rgba(67, 140, 235, 1)",o.stroke(),o.beginPath(),o.moveTo(w,0),o.lineTo(w,s.height),o.closePath(),o.lineWidth=2,o.strokeStyle="rgba(67, 140, 235, 1)",o.stroke()}if(t.playback&&t.sourceNode){const x=t.audioContext.currentTime-t.playback.startedTime,P=g(x)*N/t.rawAudioBuffer.duration+k;o.beginPath(),o.moveTo(P,0),o.lineTo(P,s.height),o.closePath(),o.strokeStyle="#ffffffff",o.lineWidth=2,o.stroke()}else if(t.playbackOffsetSeconds>0){const x=t.playbackOffsetSeconds*N/t.rawAudioBuffer.duration+k;o.beginPath(),o.moveTo(x,0),o.lineTo(x,s.height),o.closePath(),o.strokeStyle="#ffffffff",o.lineWidth=2,o.stroke()}if(o.font="14px Monospace",o.fillStyle="rgba(46, 204, 6, 1)",o.fillText("FPS: "+(1/f).toFixed(0),14,24),t.currentFile){const x=`File: ${t.currentFile.name} | ${(t.currentFile.size/1024/1024).toFixed(2)} MB`,w=o.measureText(x);o.fillStyle="rgba(255, 255, 255, 1)",o.fillText(x,s.width-w.width-10,24)}o.save(),o.fillStyle="#fff",o.textAlign="center",o.textBaseline="middle",o.fillText(he(ke()),s.width/2,24),o.restore()};requestAnimationFrame(R);const U=()=>{const d={audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,channelCount:1,sampleRate:ae}};let f=null;return async()=>{if(t.recording)f&&(f.stop(),f=null),t.recording=!1;else{const b=await navigator.mediaDevices.getUserMedia(d).catch(console.error);if(!b)return;let N=[];f=new MediaRecorder(b,{mimeType:"audio/webm"}),f.ondataavailable=x=>{console.log("New recorded data of size:",x.data.size),N.push(x.data)},f.onstop=()=>{const x=new Blob(N,{type:"audio/webm"});N=[],x.arrayBuffer().then(w=>t.audioContext.decodeAudioData(w)).then(w=>O(w)).then(()=>t.currentFile=null).catch(w=>console.error("Unable to get an array buffer from MediaRecorder:",w))},f.start(),t.recording=!0}c.innerText=t.recording?"Stop":"Record"}};c.onclick=U(),a.addEventListener("click",()=>e.click()),e.addEventListener("change",()=>{const[d]=e.files||[];if(!d)return;const f=re(d);if(!f.ok){console.error(f.message,d);return}const b=new FileReader;b.onload=()=>{b.result instanceof ArrayBuffer&&t.audioContext.decodeAudioData(b.result).then(O).then(()=>t.currentFile=d).catch(N=>console.error("Error during decoding an audio file:",N))},b.onerror=N=>{console.error("File reading error",N)},b.onprogress=N=>{console.log("File reading progress:",N)},b.readAsArrayBuffer(d)});const L=()=>{t.playback?h():I(),l.innerText=(t.playback?"Pause":"Play")+` (${K.PLAY})`};l.addEventListener("click",L),r.addEventListener("click",()=>{if(!t.rawAudioBuffer)return;h();const d=t.rawAudioBuffer;for(let f=0;f<d.numberOfChannels;f++){const b=d.getChannelData(f),N=t.selection.selected?t.selection.start:0,x=t.selection.selected?t.selection.end:b.length,w=(x-N)/2;for(let P=0;P<w;P++){const D=N+P,_=x-P-1,Y=b[D];b[D]=b[_],b[_]=Y}}i=null}),window.addEventListener("keydown",d=>{if(d.code===K.PLAY)return d.preventDefault(),L()}),s.addEventListener("mousemove",d=>{E=d.offsetX,t.rawAudioBuffer&&t.selection.selecting&&(t.selection.end=p(d.offsetX))}),s.addEventListener("mousedown",d=>{if(t.rawAudioBuffer){t.selection.selecting=!0;const f=p(d.offsetX);t.selection.start=f,t.selection.end=f}}),window.addEventListener("mouseup",d=>{const b=d.target&&d.target instanceof HTMLCanvasElement?d.offsetX:E;if(t.rawAudioBuffer&&t.selection.selecting){const N=p(b);t.selection.end=Math.max(t.selection.start,N),t.selection.start=Math.min(t.selection.start,N),t.selection.selecting=!1,t.selection.selected=t.selection.start!==t.selection.end,console.log("Selection event on mouseup:",t.selection);const x=Math.max(0,Math.min(t.selection.start,t.selection.end)/t.rawAudioBuffer.length*t.rawAudioBuffer.duration);t.playback?(h(),t.playbackOffsetSeconds=x,I()):t.playbackOffsetSeconds=x}}),s.addEventListener("wheel",d=>{if(d.preventDefault(),!t.rawAudioBuffer)return!1;const f=d.ctrlKey?.5:.1,b=1-Math.sign(d.deltaY)*f,N=Math.max(1,A*b),x=s.width*N-s.width,w=(E-k)/(s.width*A);k=Math.max(-x,Math.min(0,E-w*s.width*N)),i=null,A=N});const H=()=>{const d=v.getWidth();v.resize(d,200),s.width=document.body.clientWidth-d-30,s.height=200,i=null};window.addEventListener("resize",H),H()});
